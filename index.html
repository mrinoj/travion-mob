<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travion by Travacations - B2B Travel Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using system-ui fonts by default -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === New Corporate Blue/Slate Theme === */
        :root {
            /* Base Palette */
            --bg: #f1f5f9;          /* slate-100: Main page background */
            --panel: #ffffff;         /* white: Cards, Modals, Header */
            --panel-2: #f8fafc;       /* slate-50: Secondary content bg, hover */
            --text: #0f172a;          /* slate-900: Dark text */
            /* FIX: WCAG Contrast Fix. Was #64748b (slate-500), now darker */
            --muted: #475569;         /* slate-600: Muted text */

            /* Brand Colors (Corporate Blue) */
            --brand: #2563eb;         /* blue-600 */
            --brand-dark: #1d4ed8;    /* blue-700 (hover) */
            --brand-link: #2563eb;    /* blue-600 */
            --brand-bg: rgba(37, 99, 235, 0.1); /* blue-600 @ 10% */
            --brand-text: #1d4ed8;    /* blue-700 */

            /* Status Colors */
            --ok: #10b981;            /* emerald-500 */
            --ok-dark: #059669;       /* emerald-600 */
            --ok-bg: rgba(16, 185, 129, 0.1); /* emerald-500 @ 10% */
            --ok-text: #047857;       /* emerald-700 */

            --warn: #f59e0b;          /* amber-500 */
            --warn-dark: #d97706;     /* amber-600 */
            --warn-bg: rgba(245, 158, 11, 0.1);  /* amber-500 @ 10% */
            --warn-text: #b45309;     /* amber-700 */

            --danger: #ef4444;        /* red-500 */
            --danger-dark: #dc2626;   /* red-600 */
            --danger-bg: rgba(239, 68, 68, 0.1); /* red-500 @ 10% */
            --danger-text: #b91c1c;   /* red-700 */

            --info: #3b82f6;          /* blue-500 */
            --info-bg: rgba(59, 130, 246, 0.1); /* blue-500 @ 10% */
            --info-text: #1d4ed8;     /* blue-700 */
            
            /* Sidebar/Rail */
            --rail: #0f172a;          /* slate-900 */
            --rail-2: #1e293b;        /* slate-800 (hover) */
            --rail-text: #e2e8f0;     /* slate-200 */
            --rail-text-active: #ffffff; /* white */

            /* UI Elements */
            --input-bg: #ffffff;
            --input-border: #cbd5e1;  /* slate-300 */

            /* Radii & Shadows */
            --radius-xl: 16px;
            --radius-lg: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --radius-full: 999px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }

        /* === Base Styles === */
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--text);
        }
        .hide { display: none !important; }

        /* === Semantic Colors === */
        .text-brand { color: var(--brand); }
        .bg-brand { background-color: var(--brand); }
        .bg-brand-bg { background-color: var(--brand-bg); }
        .text-ok { color: var(--ok); }
        .bg-ok { background-color: var(--ok); }
        .text-warn { color: var(--warn); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        .bg-info { background-color: var(--info); }
        .text-muted { color: var(--muted); }

        /* === General UI Elements === */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="tel"], input[type="date"], textarea, select {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            color: var(--text);
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input::placeholder, textarea::placeholder {
            color: var(--muted);
            opacity: 0.8;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px var(--brand-bg);
        }
        /* FIX: Make date visible when not focused */
        input[type="date"] {
            color: var(--muted);
        }
        input[type="date"]:focus, input[type="date"]:valid {
            color: var(--text);
        }
        button {
            border-radius: var(--radius-full);
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s, border-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--bg), 0 0 0 5px var(--brand);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled, button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* === Button Variants === */
        .btn-primary {
            background-color: var(--brand);
            color: white;
            border-color: var(--brand);
        }
        .btn-primary:hover {
            background-color: var(--brand-dark);
            border-color: var(--brand-dark);
        }
        .btn-secondary {
            background-color: var(--panel-2);
            color: var(--text);
            border: 1px solid var(--panel-2);
        }
        .btn-secondary:hover {
            background-color: var(--bg);
            border-color: var(--bg);
        }
        /* NEW: Outline style for secondary actions */
        .btn-secondary-outline {
            background-color: var(--button-secondary-bg);
            color: var(--text);
            border: 1px solid var(--input-border);
        }
        .btn-secondary-outline:hover {
            background-color: var(--panel-2);
        }
        .btn-link {
            background: none;
            border: none;
            color: var(--brand-link);
            padding: 0;
            font-weight: 600;
        }
        .btn-link:hover {
            text-decoration: underline;
        }
        .btn-success {
            background-color: var(--ok);
            color: white;
            border-color: var(--ok);
        }
        .btn-success:hover {
            background-color: var(--ok-dark);
            border-color: var(--ok-dark);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        .btn-danger:hover {
            background-color: var(--danger-dark);
            border-color: var(--danger-dark);
        }
        /* NEW: Outline danger button */
        .btn-danger-outline {
            background-color: var(--panel);
            color: var(--danger);
            border: 1px solid var(--danger-bg);
        }
        .btn-danger-outline:hover {
            background-color: var(--danger-bg);
            color: var(--danger-dark);
        }
        .btn-warn {
            background-color: var(--warn);
            color: var(--text); /* Dark text on amber */
            border-color: var(--warn);
        }
        .btn-warn:hover {
            background-color: var(--warn-dark);
            border-color: var(--warn-dark);
        }


        /* === Cards & Panels === */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid #e5e7eb; /* Subtle border */
        }
        /* NEW: Card Action Buttons (Save, Compare, Add) */
        .card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 15;
            display: flex;
            gap: 6px;
        }
        .card-action-btn {
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .card-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .card-action-btn.save.active {
            background-color: var(--warn);
            color: var(--text);
            border-color: var(--warn);
        }
        .card-action-btn.compare.active {
            background-color: var(--info);
            border-color: var(--info);
        }
        .card-action-btn.quick-add.active {
            background-color: var(--ok);
            border-color: var(--ok);
        }
        /* Special static case for supplier card */
        .card-action-btn.save.static {
            background-color: var(--panel-2);
            color: var(--muted);
            border: 1px solid var(--input-border);
        }
        .card-action-btn.save.static:hover {
            background-color: var(--bg);
        }
        .card-action-btn.save.static.active {
            background-color: var(--warn);
            color: var(--text);
            border-color: var(--warn);
        }
        /* Special active state for outline button */
        .btn-secondary-outline.quick-add-active {
            background-color: var(--ok);
            border-color: var(--ok);
            color: white;
        }

        /* === Login Page === */
        #page-login {
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        #page-login > div {
            background: var(--panel);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            max-width: 420px;
            width: 100%;
        }
        #page-login input {
            background: var(--input-bg);
            border-color: var(--input-border);
            border-radius: var(--radius-md);
        }
        #login-button {
            background-color: var(--brand);
            color: white;
            border-radius: var(--radius-full);
        }
        #login-button:hover {
            background-color: var(--brand-dark);
        }
        #page-login a {
            color: var(--muted);
        }
        #page-login a:hover {
            color: var(--brand);
        }

        /* === Desktop Sidebar === */
        #desktop-sidebar {
            background: var(--rail);
            color: var(--rail-text);
            border-radius: 0;
            border-right: none;
            padding: 22px 18px;
        }
        #desktop-sidebar .brand-container {
            margin: 6px 6px 18px;
        }
        #desktop-sidebar h1 {
            color: white;
        }
        #sidebar-nav-content::-webkit-scrollbar {
            display: none;
        }
        #sidebar-nav-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar-link {
            color: var(--rail-text);
            border-radius: var(--radius-md); /* Slightly less rounded */
            padding: 12px 14px;
            font-weight: 500;
        }
        .sidebar-link i {
            /* FIX: Use rail text color with opacity for better visibility */
            color: var(--rail-text) !important;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .sidebar-link.active {
            background-color: var(--brand); /* Active is brand color */
            color: var(--rail-text-active); /* White text */
            box-shadow: none;
        }
        .sidebar-link.active i {
            color: var(--rail-text-active) !important; /* White icon */
            opacity: 1;
        }
        .sidebar-link:not(.active):hover {
            background-color: var(--rail-2);
            color: var(--rail-text-active);
        }
        .sidebar-link:not(.active):hover i {
            opacity: 1;
        }
        #desktop-sidebar h4 {
            color: var(--muted);
            opacity: 0.7;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        #desktop-sidebar hr {
            border-color: var(--rail-2);
        }
        #desktop-sidebar button[data-action="logout"] {
            color: var(--danger);
        }
        #desktop-sidebar button[data-action="logout"]:hover {
            background-color: var(--danger-bg);
            color: var(--danger-dark);
        }

        /* === Main Content Area === */
        .lg\\:ml-64 { margin-left: 250px; }
        #main-header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--input-border);
            border-radius: 0;
            padding: 10px 18px;
            box-shadow: var(--shadow);
        }
        #back-button {
            color: var(--muted);
        }
        #back-button:hover,
        #back-button:focus-visible {
            color: var(--text);
            background-color: var(--panel-2);
        }
        #breadcrumb-container {
            color: var(--muted);
        }
        #breadcrumb-container a {
            color: var(--brand-link);
        }
        #profile-button,
        #crisis-alert-icon,
        #create-menu-button {
            border-radius: var(--radius-full);
            transition: background-color 0.2s;
        }
        #profile-button {
            padding: 4px;
        }
        #crisis-alert-icon {
            padding: 8px;
        }
        #profile-button:hover,
        #profile-button:focus-visible,
        #crisis-alert-icon:hover,
        #crisis-alert-icon:focus-visible {
            background-color: var(--panel-2);
        }
        #create-menu-button {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        #profile-button img {
            border: 2px solid var(--panel-2);
        }

        /* === Main Content === */
        #main-content {
            background-color: var(--content-bg);
            padding: 18px;
        }
        /* NEW: High-contrast tab container for Clients, Team Hub, Saved Items */
        .app-tab-container {
            background-color: var(--panel);
            border: 1px solid var(--input-border);
            border-radius: var(--radius-full);
            padding: 4px;
            display: flex;
            gap: 4px;
        }
        .app-tab-item {
            color: var(--muted);
            font-weight: 500;
            background-color: transparent;
            box-shadow: none;
            border-radius: var(--radius-full);
            flex: 1;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        .app-tab-item.active {
            background-color: var(--brand);
            color: white;
            box-shadow: var(--shadow);
        }
        /* Specific tabs for Bookings (different style) */
        .booking-tab-container {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin: 0 -16px;
            padding: 0 16px;
            /* Hide scrollbar */
            scrollbar-width: none; /* Firefox */
        }
        .booking-tab-container::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .booking-tab {
            color: var(--muted);
            font-weight: 500;
            background-color: transparent;
            box-shadow: none;
            border-radius: var(--radius-full);
            white-space: nowrap;
            flex-shrink: 0;
            padding: 8px 16px;
        }
        .booking-tab.active {
            background-color: var(--panel); /* White active tab */
            color: var(--brand); /* Brand text */
            box-shadow: var(--shadow);
        }

        /* === Mobile Specific === */
        .fab-container { bottom: 75px; right: 18px; z-index: 999; }
        .fab {
            background-color: var(--brand);
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            z-index: 1000;
            position: relative;
        }
        .fab:active { transform: scale(0.95); }
        .fab-container.fixed {
            position: fixed;
            z-index: 999;
        }
        .fab-actions {
            position: absolute;
            bottom: 70px;
            right: 8px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 998;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        .fab-actions.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .fab-action {
            background-color: var(--panel);
            color: var(--text);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        .fab-action i {
            color: var(--brand);
        }
        
        /* Help FAB */
        #help-fab {
            position: fixed;
            bottom: 18px;
            left: 18px;
            width: 50px;
            height: 50px;
            background-color: var(--rail-2);
            color: var(--rail-text);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 998;
            border: none;
            padding: 0;
        }
        #help-fab:hover {
            background-color: var(--rail);
        }
        #help-fab:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--bg), 0 0 0 5px var(--rail-2);
        }
        /* Desktop Help FAB position adjustment */
        .lg\\:bottom-6 { bottom: 1.5rem; }
        .lg\\:left-auto { left: auto; }
        .lg\\:right-6 { right: 1.5rem; }


        /* Bottom Navigation */
        footer.fixed {
            background-color: var(--bottom-nav-bg);
            border-top: 1px solid var(--input-border);
            padding: 4px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }
        .bottom-nav-link {
            color: var(--muted);
            border-radius: var(--radius-md);
            transition: background-color 0.2s, color 0.2s;
        }
        .bottom-nav-link.active {
            color: var(--brand);
            background-color: var(--brand-bg);
        }
        .bottom-nav-link.active i {
            fill: var(--brand);
        }
        .bottom-nav-link:not(.active):hover {
            background-color: var(--panel-2);
        }

        /* === Modals === */
        /* FIX: Ensure overlay is behind content */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        .modal-content {
            background: var(--modal-bg);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0; /* Rounded top on mobile */
            padding: 24px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: auto;
            animation: slideInUp 0.3s ease-out forwards;
            z-index: 1001;
            position: relative; /* Ensure z-index applies */
        }
        @media (min-width: 1024px) {
            .modal-content {
                border-radius: var(--radius-xl);
                margin-top: 5rem;
                margin-bottom: 5rem;
                box-shadow: var(--shadow-lg);
                animation: fadeInDesktop 0.3s ease-out forwards;
            }
            @keyframes fadeInDesktop {
                from { opacity: 0; transform: translateY(-10px) scale(0.98); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }
        }
        
        /* === Toasts === */
        #toast-container {
            bottom: 80px;
            right: 18px;
            z-index: 2000;
        }
        .toast {
            background-color: var(--rail);
            color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 10px 16px;
        }
        .toast.toast-ok { background-color: var(--ok); }
        .toast.toast-danger { background-color: var(--danger); }
        .toast.toast-info { background-color: var(--rail); } /* Default dark */
        
        /* === Accordion === */
        .accordion-content {
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 12px;
            background-color: var(--bg);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            overflow: hidden;
        }
        .accordion-content.open {
            padding: 12px;
        }
        [data-action="toggleAccordion"] {
            background-color: var(--panel-2);
            border-radius: var(--radius-md);
            transition: background-color 0.2s, border-radius 0.3s;
        }
        /* NEW: Keep corners sharp when open */
        [data-action="toggleAccordion"].open {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        [data-action="toggleAccordion"]:hover {
            background-color: var(--panel);
        }

        /* === Spinner & Animations === */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInUpToast {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        .toast { animation: slideInUpToast 0.4s ease-out forwards; }

        /* === Specific Component Tweaks === */
        .status {
            border-radius: var(--radius-full);
            font-weight: 500;
            font-size: 11px;
            padding: 4px 10px;
        }
        .status.ok { background: var(--ok-bg); color: var(--ok-text); }
        .status.warn { background: var(--warn-bg); color: var(--warn-text); }
        .status.danger { background: var(--danger-bg); color: var(--danger-text); }
        .status.info { background: var(--info-bg); color: var(--info-text); }
        
        /* Booking Card Swipe */
        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
        }
        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
        }
        .swipe-action-button {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0 15px;
            cursor: pointer;
        }
        .swipe-action-button:first-child { border-top-right-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg);}
        .swipe-content {
            position: relative;
            z-index: 10;
            touch-action: pan-y;
            user-select: none;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
        }
        /* NEW: Swipe hint for mobile */
        .swipe-hint {
            position: absolute;
            top: 16px;
            left: 10px;
            font-size: 16px;
            color: var(--muted);
            opacity: 0.2;
            animation: pulse-x 1.5s ease-in-out infinite;
        }
        @keyframes pulse-x {
            0%, 100% { transform: translateX(0); opacity: 0.2; }
            50% { transform: translateX(-4px); opacity: 0.7; }
        }
        @media (min-width: 1024px) {
            .swipe-hint { display: none; }
        }

        /* Chart.js Tooltip */
        .chartjs-tooltip {
            background: rgba(15, 23, 42, 0.85) !important; /* slate-900 @ 85% */
            color: white !important;
            border-radius: var(--radius-sm) !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 2px;
        }
        
        /* Prose styles for AI content */
        .prose ul {
            list-style: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
        .prose-sm {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .max-w-none {
            max-width: none;
        }
        /* NEW: Settings link style for Profile/More */
        .settings-link {
            display: flex;
            align-items: center;
            padding: 16px;
            text-decoration: none;
            color: var(--text);
            transition: background-color 0.2s;
        }
        .settings-link:hover, .settings-link:active {
            background-color: var(--panel-2);
        }
        .settings-link i:first-child {
            color: var(--muted);
        }
        .settings-link span {
            margin-left: 1rem;
            font-weight: 500;
            flex: 1;
        }
        .settings-link i:last-child {
            color: var(--muted);
        }
        /* NEW: Search results grid */
        .search-results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media (min-width: 768px) {
            .search-results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .search-results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        /* NEW: Map Placeholder */
        .map-placeholder {
            aspect-ratio: 16/9;
            background-color: var(--bg);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .map-placeholder-content {
            text-align: center;
        }
        /* NEW: Skeleton Loading */
        @keyframes pulse {
            50% { opacity: 0.5; }
        }
        .skeleton-card {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .skeleton {
            background-color: #e2e8f0; /* slate-200 */
            border-radius: var(--radius-md);
        }
        /* NEW: Compare Table */
        .compare-table {
            border-collapse: collapse;
            width: 100%;
        }
        .compare-table th, .compare-table td {
            border: 1px solid var(--input-border);
            padding: 12px;
            text-align: left;
            vertical-align: top;
            min-width: 150px;
        }
        .compare-table th {
            background-color: var(--panel-2);
            text-align: center;
        }
        .compare-table td:first-child {
            font-weight: 600;
            background-color: var(--panel-2);
            width: 20%;
            min-width: 120px;
        }
        /* NEW: Quick Itinerary Bar */
        #quick-itinerary-bar {
            position: fixed;
            bottom: -100px;
            left: 18px;
            right: 18px;
            background-color: var(--rail);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 990;
            transition: transform 0.3s ease-out;
            transform: translateY(0);
        }
        #quick-itinerary-bar.visible {
            transform: translateY(-80px);
        }
        @media (min-width: 1024px) {
            #quick-itinerary-bar {
                left: auto;
                width: 300px;
                bottom: -100px;
                transform: translateY(0);
            }
            #quick-itinerary-bar.visible {
                transform: translateY(-24px); /* bottom-6 */
            }
        }
        /* NEW: Quick Itinerary Modal List */
        .quick-itin-item-list div {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: var(--radius-md);
        }
        .quick-itin-item-list div:hover {
            background-color: var(--panel-2);
        }
        /* NEW: Saved Items Page Desktop Layout */
        .saved-items-layout {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        @media (min-width: 1024px) {
            .saved-items-layout {
                flex-direction: row;
            }
            .saved-items-nav {
                width: 250px;
                flex-shrink: 0;
            }
            .saved-items-content {
                flex: 1;
                min-width: 0;
            }
            /* NEW: Saved Items Vertical Nav */
            .saved-items-nav .app-tab-container {
                flex-direction: column;
                border-radius: var(--radius-lg);
                padding: 6px;
                gap: 6px;
            }
            .saved-items-nav .app-tab-item {
                flex: 1;
                width: 100%;
                display: flex;
                justify-content: flex-start;
                padding: 10px 14px;
                font-weight: 500;
            }
            .saved-items-nav .app-tab-item i {
                margin-right: 12px;
                font-size: 1.125rem;
            }
            .saved-items-nav .app-tab-item .tab-count {
                margin-left: auto;
                background-color: var(--bg);
                color: var(--muted);
                font-size: 11px;
                font-weight: 600;
                padding: 2px 6px;
                border-radius: var(--radius-full);
            }
            .saved-items-nav .app-tab-item.active .tab-count {
                background-color: var(--brand-dark);
                color: white;
            }
        }
        /* NEW: Search Suggestion Pills */
        .search-suggestion-pill {
            background-color: var(--panel);
            color: var(--muted);
            border: 1px solid var(--input-border);
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
        }
        .search-suggestion-pill:hover {
            background-color: var(--panel-2);
            color: var(--text);
        }
        /* NEW: Search View Toggle */
        .search-view-toggle {
            padding: 8px 12px;
            border-radius: var(--radius-full);
            color: var(--muted);
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .search-view-toggle.active {
            background-color: var(--panel);
            color: var(--brand);
            box-shadow: var(--shadow);
        }
        .filter-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--brand);
            color: white;
            font-size: 10px;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--panel);
        }


    </style>
</head>
<body class="bg-neutral-bg">
    <!-- App Container -->
    <div id="app-container">
        <!-- ====================================================== -->
        <!-- ============== LOGIN / ONBOARDING PAGE =============== -->
        <!-- ====================================================== -->
        <div id="page-login">
            <div>
                <div class="text-center mb-10">
                    <div class="inline-block p-4 rounded-full bg-rail">
                        <i class="ph-airplane-takeoff text-5xl text-white"></i>
                    </div>
                    <h1 class="text-4xl font-bold mt-4">Travion</h1>
                    <p class="mt-2 text-lg text-muted">The Future of B2B Travel</p>
                </div>
                <div class="space-y-4">
                    <input type="email" placeholder="Email" value="rajesh.kumar@example.com">
                    <input type="password" placeholder="Password" value="••••••••">
                </div>
                <button id="login-button" class="btn-primary w-full !py-3 !px-4 mt-8">Login</button>
                <div class="text-center mt-6">
                    <a href="#" class="text-sm text-muted hover:text-brand">Forgot Password?</a>
                </div>
            </div>
        </div>
        <!-- ====================================================== -->
        <!-- =================== MAIN APP SHELL =================== -->
        <!-- ====================================================== -->
        <div id="page-main" class="hide flex flex-col lg:flex-row h-screen">
            <!-- ====================================================== -->
            <!-- =================== DESKTOP SIDEBAR ================== -->
            <!-- ====================================================== -->
            <nav id="desktop-sidebar" class="hidden lg:flex flex-col w-[250px] h-screen fixed top-0 left-0 z-20">
                <!-- Sidebar Header -->
                <div class="brand-container flex items-center space-x-2 p-2 mb-4">
                    <div class="inline-block p-3 rounded-lg bg-rail-2">
                        <i class="ph-airplane-takeoff text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold">Travion</h1>
                </div>
                
                <!-- Sidebar Navigation -->
                <div id="sidebar-nav-content" class="flex-1 space-y-1 px-1.5 overflow-y-auto">
                    <button data-view="dashboard" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-house text-xl mr-3"></i><span>Dashboard</span>
                    </button>
                    <button data-view="bookings" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-briefcase text-xl mr-3"></i><span>Bookings</span>
                    </button>
                    <button data-view="search" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-magnifying-glass text-xl mr-3"></i><span>Search</span>
                    </button>
                    <button data-view="marketplace" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-storefront text-xl mr-3"></i><span>Deals</span>
                    </button>
                    <hr class="my-2 border-rail-2">
                    <h4 class="px-3 text-xs font-semibold uppercase tracking-wider">Workspace</h4>
                    <button data-view="team_hub" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-users-three text-xl mr-3"></i><span>Team Hub</span>
                    </button>
                    <button data-view="clients" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-users text-xl mr-3"></i><span>Clients</span>
                    </button>
                    <button data-view="trust_hub" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-handshake text-xl mr-3"></i><span>Trust Hub</span>
                    </button>
                    <button data-view="finance" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-currency-inr text-xl mr-3"></i><span>Finance</span>
                    </button>
                    <button data-view="analytics" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-chart-bar text-xl mr-3"></i><span>Analytics</span>
                    </button>
                    <button data-view="saved" class="sidebar-link bottom-nav-link w-full flex items-center">
                        <i class="ph-bookmark-simple text-xl mr-3"></i><span>Saved Items</span>
                    </button>
                </div>
                <!-- Sidebar Footer -->
                <div class="mt-auto pt-4 border-t border-rail-2 px-1.5">
                    <button data-action="logout" class="w-full flex items-center p-3 rounded-md font-medium hover:bg-danger-bg">
                        <i class="ph-sign-out text-xl mr-3"></i><span>Logout</span>
                    </button>
                </div>
            </nav>
            <!-- Main Content Area (Mobile + Desktop) -->
            <div class="flex-1 flex flex-col h-screen lg:ml-64">
                <!-- Header -->
                <header id="main-header" class="flex justify-between items-center z-10 sticky top-0 lg:w-full">
                    <div class="flex items-center">
                        <button id="back-button" class="hide mr-2 p-1 rounded-full">
                            <i class="ph-arrow-left text-2xl"></i>
                        </button>
                        <div>
                            <!-- Breadcrumbs for desktop, hidden on mobile -->
                            <div id="breadcrumb-container" class="text-xs truncate hidden lg:block"></div>
                            <h1 id="header-title" class="text-xl font-bold">Dashboard</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 lg:space-x-4">
                        
                        <!-- Create Button (Desktop Only) -->
                        <div id="create-menu-container" class="relative hidden lg:block">
                            <button id="create-menu-button" class="btn-primary flex items-center space-x-2 !py-2 !px-4">
                                <i class="ph-plus text-lg"></i>
                                <span>Create new</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="create-menu-dropdown" class="hide absolute right-0 mt-2 w-48 card p-2 z-50 shadow-lg">
                                <button data-action="newBooking" class="w-full text-left p-2 rounded-md hover:bg-panel-2 flex items-center text-sm"><i class="ph-briefcase text-lg mr-2"></i>New Booking</button>
                                <button data-action="newItinerary" class="w-full text-left p-2 rounded-md hover:bg-panel-2 flex items-center text-sm"><i class="ph-scroll text-lg mr-2"></i>New Itinerary</button>
                            </div>
                        </div>

                        <div id="crisis-alert-icon" class="relative cursor-pointer hide p-2 rounded-full">
                            <i class="ph-bell-ringing text-2xl text-danger"></i>
                            <span class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-danger"></span>
                        </div>
                        <div id="profile-button" class="flex items-center space-x-2 cursor-pointer p-1 rounded-full">
                            <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=80&q=80" class="w-9 h-9 rounded-full" alt="User Avatar" onerror="this.src='https://placehold.co/40x40/2563eb/FFFFFF?text=RK'">
                        </div>
                    </div>
                </header>
                <!-- Main Content -->
                <main id="main-content" class="flex-1 overflow-y-auto pb-24 lg:pb-6">
                    <!-- Content will be injected here -->
                </main>
            </div>
            <!-- ====================================================== -->
            <!-- =============== MOBILE-ONLY ELEMENTS ================= -->
            <!-- ====================================================== -->
            <!-- FAB (Hidden on Desktop) -->
            <div id="fab-container" class="fab-container fixed lg:hidden">
                 <!-- Actions -->
                <div id="fab-actions" class="fab-actions">
                    <div data-action="newBooking" class="fab-action cursor-pointer">
                        <span class="mr-2">New Booking</span> <i class="ph-briefcase text-xl"></i>
                    </div>
                    <div data-action="newItinerary" class="fab-action cursor-pointer">
                        <span class="mr-2">New Itinerary</span> <i class="ph-scroll text-xl"></i>
                    </div>
                </div>
                 <!-- Main Button -->
                <button id="fab" class="fab flex items-center justify-center text-white">
                    <i class="ph-plus text-3xl transition-transform"></i>
                </button>
            </div>
            <!-- Bottom Navigation (Hidden on Desktop) -->
            <footer class="fixed bottom-0 left-0 right-0 flex justify-around z-10 lg:hidden">
                    <button data-view="dashboard" class="bottom-nav-link flex flex-col items-center w-full py-1">
                        <i class="ph-fill ph-house text-2xl"></i><span class="text-xs mt-1">Dashboard</span>
                    </button>
                    <button data-view="bookings" class="bottom-nav-link flex flex-col items-center w-full py-1">
                        <i class="ph-fill ph-briefcase text-2xl"></i><span class="text-xs mt-1">Bookings</span>
                    </button>
                    <button data-view="search" class="bottom-nav-link flex flex-col items-center w-full py-1">
                        <i class="ph-fill ph-magnifying-glass text-2xl"></i><span class="text-xs mt-1">Search</span>
                    </button>
                    <button data-view="saved" class="bottom-nav-link flex flex-col items-center w-full py-1">
                        <i class="ph-fill ph-bookmark-simple text-2xl"></i><span class="text-xs mt-1">Saved</span>
                    </button>
                    <button data-view="more" class="bottom-nav-link flex flex-col items-center w-full py-1">
                        <i class="ph-fill ph-dots-three-circle text-2xl"></i><span class="text-xs mt-1">More</span>
                    </button>
            </footer>

            <!-- Help FAB (All Screens) - Moved to bottom-right on desktop -->
            <button id="help-fab" data-action="showContextualHelp" aria-label="How to Use" class="lg:bottom-6 lg:left-auto lg:right-6">
                <i class="ph-question text-2xl"></i>
            </button>
            
            <!-- NEW: Quick Itinerary Bar (Hidden by default) -->
            <div id="quick-itinerary-bar" class="">
                <div class="flex items-center">
                    <i class="ph-scroll text-2xl text-brand mr-2"></i>
                    <div>
                        <p class="font-bold text-sm leading-tight">Quick Itinerary</p>
                        <p id="quick-itin-count" class="text-xs leading-tight opacity-80">0 items added</p>
                    </div>
                </div>
                <button data-action="reviewQuickItinerary" class="btn-primary !text-sm !py-1.5 !px-3">Review</button>
            </div>


            <!-- Modal and Toast Container -->
            <div id="modal-container" class="hide fixed inset-0 z-[1000] flex items-end lg:items-start justify-center overflow-y-auto"></div>
            <div id="toast-container" class="fixed right-4 z-[2000] space-y-2"></div>
        </div>
    </div>
    <script>
    // ========================================================================
    // ========================= MOCK DATA (EXPANDED) =========================
    // ========================================================================
    const mockData = {
        user: { id: 'U_01', name: "Rajesh Kumar", role: 'Admin', agency: "Mumbai Travel Co.", points: 1250, rank: 12, badges: ["Goa Expert", "Top Reviewer '25"], stats: { closed: 15, revenue: 1250000, margin: 19.2, monthlyGoal: 2000000 } },
        teams: ["Packages Team", "Flights Team", "Operations Team", "Finance Team"],
        staff: [
            { id: 'U_02', name: "Priya S.", role: 'Manager', team: 'Packages Team', stats: { closed: 12, revenue: 850000, margin: 18.5, monthlyGoal: 1000000 } },
            { id: 'U_03', name: "Amit P.", role: 'Agent', team: 'Packages Team', stats: { closed: 8, revenue: 520000, margin: 16.2, monthlyGoal: 700000 } },
            { id: 'U_04', name: "Sunita M.", role: 'Agent', team: 'Flights Team', stats: { closed: 25, revenue: 310000, margin: 8.1, monthlyGoal: 400000 } },
            { id: 'U_05', name: "Rohan V.", role: 'Agent', team: 'Operations Team', stats: { closed: 10, revenue: 610000, margin: 17.5, monthlyGoal: 600000 } },
        ],
        teamActivity: [
            {id: 'TA_01', text: "Priya S. sent a quote to Mehta Couple.", timestamp: '2025-10-10T09:00:00Z'},
            {id: 'TA_02', text: "A new inquiry for Goa was created.", timestamp: '2025-10-10T08:30:00Z'},
            {id: 'TA_03', text: "Amit P. moved Gupta Group to 'Confirmed'.", timestamp: '2025-10-09T17:00:00Z'},
            {id: 'TA_04', text: "Finance Team marked INV-003 as Paid.", timestamp: '2025-10-09T16:00:00Z'},
            {id: 'TA_05', text: "Sunita M. added a new supplier 'Goa Cabs'.", timestamp: '2025-10-09T15:00:00Z'},
            {id: 'TA_06', text: "Rohan V. confirmed vouchers for BK104.", timestamp: '2025-10-09T14:00:00Z'},
            {id: 'TA_07', text: "Amit P. created a new itinerary for Sharma Family.", timestamp: '2025-10-09T11:00:00Z'},
        ],
        leaderboard: [
            { rank: 1, name: "Priya S.", agency: "Jaipur Journeys", points: 2100 },
            { rank: 2, name: "Amit P.", agency: "Himalayan Tours", points: 1980 },
            { rank: 3, name: "Sunita M.", agency: "Delhi Voyagers", points: 1850 },
            { rank: 4, name: "Ravi K.", agency: "South India Travels", points: 1700 },
            { rank: 12, name: "Rajesh Kumar", agency: "Mumbai Travel Co.", points: 1250, isCurrentUser: true },
        ],
        smartFeed: [
            { id: 'sf_01', type: 'opportunity', title: 'Pricing Opportunity', text: "Flights to Goa are trending 15% higher for next month. Create a Goa package now to lock in better rates.", action: 'runCategorySearch', actionText: 'Create Package', view: 'search_results', query: 'Goa Packages', icon: 'ph-trend-up' },
            { id: 'sf_02', type: 'engagement', title: 'Client Engagement', text: "You haven't contacted the Sharma Family in 3 weeks. They usually book their winter vacation now. Send them some Manali options?", action: 'navigate', actionText: 'Send Options', view: 'client_details', clientId: 'C_01', icon: 'ph-users' },
            { id: 'sf_03', type: 'alert', title: 'Supplier Alert', text: "Jaipur Royal Cabs' Trust Score dropped 5 points this month due to reviews on vehicle cleanliness.", action: 'navigate', actionText: 'View Details', view: 'supplier_details', supplierId: 'SUP_01', icon: 'ph-warning-circle' },
        ],
        kpis: [
            { label: "Bookings this month", value: "87", change: "+5%" },
            { label: "Total Revenue", value: "₹28.5L", change: "+12%" },
            { label: "Client Satisfaction", value: "4.8/5", change: "+0.1" },
            { label: "Avg. Response Time", value: "2.1 hrs", change: "-8%" },
        ],
        upcomingDepartures: [
            { bookingId: 'BK104', client: 'Jain Corporation', destination: 'Delhi-Agra', departureDate: '2025-10-10' },
            { bookingId: 'BK103', client: 'Mr. Patel', destination: 'Udaipur', departureDate: '2025-10-12' },
        ],
        deals: [
            { id: 'DEAL_UDAIPUR_01', title: "5-Star Oberoi, Udaipur", discount: "40% OFF", description: "Last minute deal for lake-view rooms.", img: `https://images.unsplash.com/photo-1544642954-1ea05127f1b3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dWRhaXB1ciUyMGhvdGVsfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=80`, type: 'Flash Sale', expiration: new Date().getTime() + 2 * 60 * 60 * 1000, packageId: 'PKG_UDAIPUR_01' },
            { id: 'DEAL_KERALA_01', title: "Kerala Backwaters Houseboat", discount: "25% OFF", description: "Exclusive monsoon package.", img: `https://images.unsplash.com/photo-1528181304800-259b08848526?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8a2VyYWxhJTIwaG91c2Vib2F0fGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=80`, type: 'Exclusive', packageId: 'PKG_KERALA_01'},
        ],
        bookings: [
            // 10+ Bookings
            { id: 'BK101', client: "Sharma Family", destination: "Goa", status: "Inquiry", value: 120000, invoice: null, travelDate: '2025-11-20', travelers: 4, assignedTo: null, lastUpdated: '2025-10-09T10:00:00Z' },
            { id: 'BK102', client: "Gupta Group", destination: "Kerala", status: "Quoted", value: 250000, invoice: null, travelers: 12, assignedTo: 'Packages Team', lastUpdated: '2025-10-08T15:30:00Z' },
            { id: 'BK103', client: "Mr. Patel", destination: "Udaipur", status: "Confirmed", value: 85000, invoice: null, travelDate: '2025-10-12', travelers: 2, assignedTo: 'Operations Team', lastUpdated: '2025-10-07T11:00:00Z' },
            { id: 'BK104', client: "Jain Corporation", destination: "Delhi-Agra", status: "In-Progress", value: 450000, invoice: { id: 'INV-002', status: 'Due', amount: 450000, paid: 200000, paymentDate: '2025-10-08' }, travelDate: '2025-10-10', travelers: 20, assignedTo: 'Operations Team', lastUpdated: '2025-10-06T18:00:00Z' },
            { id: 'BK105', client: "Mehta Couple", destination: "Andaman", status: "Completed", value: 180000, invoice: { id: 'INV-003', status: 'Paid', amount: 180000, paid: 180000, paymentDate: '2025-10-09' }, travelDate: '2025-09-15', travelers: 2, assignedTo: 'Operations Team', lastUpdated: '2025-09-20T14:00:00Z' },
            { id: 'BK106', client: "Verma Partners", destination: "Manali", status: "Completed", value: 95000, packageId: 'PKG_MANALI_01', invoice: { id: 'INV-004', status: 'Overdue', amount: 95000, paid: 0 }, travelDate: '2025-09-01', travelers: 2, assignedTo: 'Packages Team', lastUpdated: '2025-10-01T09:00:00Z' },
            { id: 'BK107', client: "Singh & Sons", destination: "Rajasthan", status: "Inquiry", value: 310000, invoice: null, travelDate: '2025-12-05', travelers: 8, assignedTo: null, lastUpdated: '2025-10-10T11:00:00Z' },
            { id: 'BK108', client: "Ahuja Textiles", destination: "Kashmir", status: "Confirmed", value: 550000, invoice: { id: 'INV-005', status: 'Due', amount: 550000, paid: 250000 }, travelDate: '2025-11-15', travelers: 15, assignedTo: 'Priya S.', lastUpdated: '2025-10-09T14:20:00Z' },
            { id: 'BK109', client: "Dr. Reddy", destination: "Ooty", status: "Quoted", value: 75000, invoice: null, travelDate: '2025-10-25', travelers: 2, assignedTo: 'Amit P.', lastUpdated: '2025-10-10T09:30:00Z' },
            { id: 'BK110', client: "Goa Getaway Group", destination: "Goa", status: "In-Progress", value: 150000, invoice: { id: 'INV-006', status: 'Paid', amount: 150000, paid: 150000 }, travelDate: '2025-10-11', travelers: 6, assignedTo: 'Sunita M.', lastUpdated: '2025-10-10T10:00:00Z' },
            { id: 'BK111', client: "Himalayan Trekkers", destination: "Sikkim", status: "Inquiry", value: 220000, invoice: null, travelDate: '2026-03-01', travelers: 10, assignedTo: null, lastUpdated: '2025-10-10T12:00:00Z' },
        ],
        recentSearches: ["Manali", "hotels in Goa", "flights to Delhi", "Kerala packages"],
        // NEW: Browse categories with mock data
        browseCategories: [
            { name: "Beach", img: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YmVhY2h8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80", query: "Goa packages" },
            { name: "Hills", img: "https://images.unsplash.com/photo-1549880181-56a44cf4a9a5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8bW91bnRhaW5zfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80", query: "Manali packages" },
            { name: "Heritage", img: "https://images.unsplash.com/photo-1524492412937-b28074a5d7da?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dGFqJTIwbWFoYWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80", query: "Rajasthan heritage hotels" },
            { name: "Spiritual", img: "https://images.unsplash.com/photo-1529608013385-5478a5e4a317?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dmFyYW5hc2l8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80", query: "Varanasi hotels" },
            { name: "Backwaters", img: "https://images.unsplash.com/photo-1602216056096-3b40402e9a0b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8a2VyYWxhfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80", query: "Kerala houseboat" },
            { name: "Wildlife", img: "https://images.unsplash.com/photo-1583310405101-2c5f5995e8cf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dGlnZXJ8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80", query: "Ranthambore packages" },
        ],
        // 10+ Search Results (Packages, Hotels, Flights)
        searchResults: [
            // Packages (10)
            { id: 'PKG_GOA_01', type: 'Package', title: "Goa Family Fun Package", price: 115000, rating: 4.9, details: "Includes 4-star hotel, flights, and activities.", img: `https://images.unsplash.com/photo-1580790215771-0849c4e13c6a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGdvYSUyMGZhbWlseXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Goa', duration: 5, inclusions: ['Hotel', 'Flights', 'Activities'] },
            { id: 'PKG_MANALI_01', type: 'Package', title: "Himalayan Escape Package", price: 95000, rating: 4.8, details: "7-day trip to Manali with stay and tours.", img: `https://images.unsplash.com/photo-1586524104083-207d71d78a87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bWFuYWxpJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=80`, baseCost: 75000, dayWisePlan: [{ day: 1, title: "Arrival in Manali & Leisure", activities: ["Transfer to hotel", "Acclimatize", "Evening at Mall Road"], hotelId: 'HOTEL_MANALI_01' }, { day: 2, title: "Solang Valley", activities: ["Visit Solang Valley", "Adventure sports"], hotelId: 'HOTEL_MANALI_01' }], destination: 'Manali', duration: 7, inclusions: ['Hotel', 'Tours'] },
            { id: 'PKG_KERALA_01', type: 'Package', title: "Kerala Backwaters Bliss", price: 130000, rating: 4.7, details: "5-day trip with houseboat stay.", img: `https://images.unsplash.com/photo-1602216056096-3b40402e9a0b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8a2VyYWxhfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=80`, baseCost: 100000, dayWisePlan: [{ day: 1, title: "Arrival in Kochi", activities: ["Transfer to hotel", "Fort Kochi Tour"], hotelId: 'HOTEL_KOCHI_01' }, { day: 2, title: "Houseboat", activities: ["Check into Houseboat"], hotelId: 'HOUSEBOAT_01' }], destination: 'Kerala', duration: 5, inclusions: ['Hotel', 'Houseboat'] },
            { id: 'PKG_RAJASTHAN_01', type: 'Package', title: "Royal Rajasthan Tour", price: 210000, rating: 4.9, details: "10-day luxury heritage tour.", img: `https://images.unsplash.com/photo-1547209127-3e6c3031b212?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8amFpcHVyJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Rajasthan', duration: 10, inclusions: ['Hotel', 'Flights', 'Tours', 'Transport'] },
            { id: 'PKG_ANDAMAN_01', type: 'Package', title: "Andaman Island Hopper", price: 175000, rating: 4.8, details: "6-day trip to Havelock and Neil islands.", img: `https://images.unsplash.com/photo-1609192188613-7310a51c4b7b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YW5kYW1hbiUyMGJlYWNofGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=80`, destination: 'Andaman', duration: 6, inclusions: ['Hotel', 'Ferry', 'Activities'] },
            { id: 'PKG_KASHMIR_01', type: 'Package', title: "Kashmir Paradise Escape", price: 190000, rating: 4.9, details: "7-day tour of Srinagar, Gulmarg, and Pahalgam.", img: `https://images.unsplash.com/photo-1587474260584-13a535175630?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8a2FzaG1pcnxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Kashmir', duration: 7, inclusions: ['Hotel', 'Flights', 'Transport'] },
            { id: 'PKG_GOA_02', type: 'Package', title: "Goa Luxury Break", price: 180000, rating: 5.0, details: "4-day luxury stay at The Leela.", img: `https://images.unsplash.com/photo-1584132967334-10e028bd69f7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OHx8Z29hJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Goa', duration: 4, inclusions: ['5-Star Hotel', 'Flights'] },
            { id: 'PKG_RANTHAMBORE_01', type: 'Package', title: "Ranthambore Tiger Safari", price: 110000, rating: 4.6, details: "3-day package with 2 safaris included.", img: `https://images.unsplash.com/photo-1583310405101-2c5f5995e8cf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dGlnZXJ8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Ranthambore', duration: 3, inclusions: ['Hotel', 'Safaris'] },
            { id: 'PKG_SIKKIM_01', type: 'Package', title: "Mystical Sikkim", price: 165000, rating: 4.7, details: "8-day tour of Gangtok and Pelling.", img: `https://images.unsplash.com/photo-1583161803233-317d057ade82?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8c2lra2ltfGVufDB8fDB8fHww&auto=format&fit=crop&w=600&q=80`, destination: 'Sikkim', duration: 8, inclusions: ['Hotel', 'Tours', 'Transport'] },
            { id: 'PKG_UDAIPUR_01', type: 'Package', title: "Udaipur Lake Getaway", price: 85000, rating: 4.8, details: "4-day heritage stay by Lake Pichola.", img: `https://images.unsplash.com/photo-1571504869158-6c0b5d92e10c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8dWRhaXB1cnxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=600&q=80`, destination: 'Udaipur', duration: 4, inclusions: ['Hotel', 'Tours'] },
            // Hotels (10)
            { id: 'HOTEL_MANALI_01', type: 'Hotel', name: "The Himalayan Resort", destination: "Manali", rating: 4.8, price: 12000, img: 'https://images.unsplash.com/photo-1586524104083-207d71d78a87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bWFuYWxpJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Wi-Fi'] },
            { id: 'HOTEL_MANALI_02', type: 'Hotel', name: "Snow Valley Resorts", destination: "Manali", rating: 4.5, price: 9000, img: 'https://images.unsplash.com/photo-1540541338287-41700207dee6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8bWFuYWxpJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Wi-Fi', 'Restaurant'] },
            { id: 'HOTEL_KOCHI_01', type: 'Hotel', name: "Trident Kochi", destination: "Kochi", rating: 4.6, price: 11000, img: 'https://images.unsplash.com/photo-1596394516093-501ba68a0ba6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8a29jaGklMjBob3RlbHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Wi-Fi'] },
            { id: 'HOUSEBOAT_01', type: 'Hotel', name: "Premium Houseboat", destination: "Alleppey", rating: 4.9, price: 15000, img: 'https://images.unsplash.com/photo-1528181304800-259b08848526?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8a2VyYWxhJTIwaG91c2Vib2F0fGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', amenities: ['Private Chef', 'A/C'] },
            { id: 'HOTEL_GOA_01', type: 'Hotel', name: "Taj Exotica Resort & Spa", destination: "Goa", rating: 4.9, price: 22000, img: 'https://images.unsplash.com/photo-1584132967334-10e028bd69f7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8bHV4dXJ5JTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Wi-Fi', 'Private Beach'] },
            { id: 'HOTEL_GOA_02', type: 'Hotel', name: "W Goa", destination: "Goa", rating: 4.8, price: 20000, img: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8Z29hJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Wi-Fi', 'Nightclub'] },
            { id: 'HOTEL_GOA_03', type: 'Hotel', name: "Alila Diwa Goa", destination: "Goa", rating: 4.7, price: 16000, img: 'https://images.unsplash.com/photo-1590073242678-70ee3fc2f7b2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGdvYSUyMGhvdGVsfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Wi-Fi'] },
            { id: 'HOTEL_JAIPUR_01', type: 'Hotel', name: "Rambagh Palace", destination: "Jaipur", rating: 5.0, price: 45000, img: 'https://images.unsplash.com/photo-1548013146-72479768bada?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8cmFqYXN0aGFuJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Heritage', 'Wi-Fi'] },
            { id: 'HOTEL_JAIPUR_02', type: 'Hotel', name: "Samode Haveli", destination: "Jaipur", rating: 4.8, price: 18000, img: 'https://images.unsplash.com/photo-1617594222213-c3b9b951f661?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cmFqYXN0aGFuJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Heritage', 'Wi-Fi'] },
            { id: 'HOTEL_DELHI_01', type: 'Hotel', name: "The Imperial", destination: "Delhi", rating: 4.9, price: 19000, img: 'https://images.unsplash.com/photo-1568495112311-2051d2731c3c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZGVsaGklMjBob3RlbHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=300&q=80', amenities: ['Pool', 'Spa', 'Wi-Fi'] },
            // Flights (10)
            { id: 'FL_BOMGOA_01', type: 'Flight', from: "Mumbai", to: "Goa", airline: "IndiGo", flightNo: "6E 204", departure: "08:30", arrival: "09:45", duration: "1h 15m", price: 4500, stops: 0, img: 'https://logo.clearbit.com/goindigo.in' },
            { id: 'FL_DELBOM_01', type: 'Flight', from: "Delhi", to: "Mumbai", airline: "Air India", flightNo: "AI 887", departure: "10:00", arrival: "12:05", duration: "2h 05m", price: 5200, stops: 0, img: 'https://logo.clearbit.com/airindia.com' },
            { id: 'FL_BLRBOM_01', type: 'Flight', from: "Bangalore", to: "Mumbai", airline: "Vistara", flightNo: "UK 850", departure: "11:30", arrival: "13:05", duration: "1h 35m", price: 4800, stops: 0, img: 'https://logo.clearbit.com/airvistara.com' },
            { id: 'FL_BOMGOA_02', type: 'Flight', from: "Mumbai", to: "Goa", airline: "Akasa Air", flightNo: "QP 113", departure: "12:00", arrival: "13:10", duration: "1h 10m", price: 4300, stops: 0, img: 'https://logo.clearbit.com/akasaair.com' },
            { id: 'FL_DELGOA_01', type: 'Flight', from: "Delhi", to: "Goa", airline: "SpiceJet", flightNo: "SG 171", departure: "14:00", arrival: "16:30", duration: "2h 30m", price: 5500, stops: 0, img: 'https://logo.clearbit.com/spicejet.com' },
            { id: 'FL_MAABOM_01', type: 'Flight', from: "Chennai", to: "Mumbai", airline: "IndiGo", flightNo: "6E 502", departure: "16:00", arrival: "17:50", duration: "1h 50m", price: 4900, stops: 0, img: 'https://logo.clearbit.com/goindigo.in' },
            { id: 'FL_DELBLR_01', type: 'Flight', from: "Delhi", to: "Bangalore", airline: "Air India", flightNo: "AI 505", departure: "17:00", arrival: "19:40", duration: "2h 40m", price: 5800, stops: 0, img: 'https://logo.clearbit.com/airindia.com' },
            { id: 'FL_BOMDEL_01', type: 'Flight', from: "Mumbai", to: "Delhi", airline: "Vistara", flightNo: "UK 990", departure: "19:00", arrival: "21:05", duration: "2h 05m", price: 5300, stops: 0, img: 'https://logo.clearbit.com/airvistara.com' },
            { id: 'FL_DELBOM_02', type: 'Flight', from: "Delhi", to: "Mumbai", airline: "IndiGo", flightNo: "6E 2045", departure: "09:00", arrival: "13:10", duration: "4h 10m", price: 4800, stops: 1, img: 'https://logo.clearbit.com/goindigo.in' },
            { id: 'FL_BOMDEL_02', type: 'Flight', from: "Mumbai", to: "Delhi", airline: "Air India", flightNo: "AI 670", departure: "11:00", arrival: "15:30", duration: "4h 30m", price: 5000, stops: 1, img: 'https://logo.clearbit.com/airindia.com' },
        ],
        crisis: {
            bookingId: 'BK104', client: "Jain Corporation", issue: "Flight to Agra Cancelled (Weather)", impact: "12 passengers stranded in Delhi.",
            alternatives: [ { type: 'Flight', details: "SpiceJet SG 8169, Departs in 3 hours", cost: "+₹15,000" }, { type: 'Train', details: "Gatimaan Express, Departs tomorrow 8 AM", cost: "-₹5,000" }, ]
        },
        suppliers: [
            // 10+ Suppliers
            { id: 'SUP_01', type: 'Supplier', name: "Jaipur Royal Cabs", rating: 4.9, reviews: 152, trustScore: 98, service: "Transport", verified: true, img: 'https://images.unsplash.com/photo-1599462252136-e3c660136390?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8amFpcHVyJTIwY2FyfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 98, value: 95, partnership: 97 }, peerReviews: [{by: 'Goa Travels', rating: 5, comment: 'Always on time, clean cars. Highly recommended.'}, {by: 'Himalayan Tours', rating: 4, comment: 'Good service, but prices are a bit high during peak season.'}] },
            { id: 'SUP_02', type: 'Supplier', name: "Goa Paradise Hotels", rating: 4.7, reviews: 210, trustScore: 92, service: "Accommodation", verified: true, img: 'https://images.unsplash.com/photo-1571003123894-1f0594d2b5d9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8Z29hJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 95, value: 92, partnership: 90 }, peerReviews: [{by: 'Mumbai Voyager', rating: 5, comment: 'Excellent properties and very supportive staff.'}] },
            { id: 'SUP_03', type: 'Supplier', name: "Kerala River Tours", rating: 4.8, reviews: 180, trustScore: 95, service: "Activity", verified: true, img: 'https://images.unsplash.com/photo-1593693411515-c202a6138c7f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8a2VyYWxhJTIwYm9hdHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 96, value: 94, partnership: 95 }, peerReviews: [{by: 'Delhi Voyagers', rating: 5, comment: 'Authentic experience.'}] },
            { id: 'SUP_04', type: 'Supplier', name: "Himalayan Treks", rating: 4.5, reviews: 95, trustScore: 88, service: "Activity", verified: false, img: 'https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8aGltYWxheWFuJTIwdHJla2tpbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 90, value: 85, partnership: 89 }, peerReviews: [{by: 'Jaipur Journeys', rating: 4, comment: 'Guides are knowledgeable, but equipment is average.'}] },
            { id: 'SUP_05', type: 'Supplier', name: "Delhi Fast Track", rating: 4.2, reviews: 120, trustScore: 80, service: "Transport", verified: true, img: 'https://images.unsplash.com/photo-1573518380317-0808a3c10f83?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZGVsaGklMjB0YXhpfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 85, value: 80, partnership: 75 }, peerReviews: [{by: 'South India Travels', rating: 3, comment: 'Often late for pickups.'}] },
            { id: 'SUP_06', type: 'Supplier', name: "Agra Guide Services", rating: 4.9, reviews: 250, trustScore: 97, service: "Activity", verified: true, img: 'https://images.unsplash.com/photo-1564510036622-671e3c483a3f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OHx8YWdyYXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 98, value: 96, partnership: 97 }, peerReviews: [{by: 'Mumbai Voyager', rating: 5, comment: 'Our clients love their guides.'}] },
            { id: 'SUP_07', type: 'Supplier', name: "Andaman Scuba Co.", rating: 4.8, reviews: 130, trustScore: 93, service: "Activity", verified: true, img: 'https://images.unsplash.com/photo-1568502206640-3c13702137a1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YW5kYW1hbiUyMHNjdWJhfGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 95, value: 90, partnership: 94 }, peerReviews: [] },
            { id: 'SUP_08', type: 'Supplier', name: "Mumbai Airport Xfers", rating: 4.6, reviews: 310, trustScore: 90, service: "Transport", verified: true, img: 'https://images.unsplash.com/photo-1560179407-c287c2b33633?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8bXVtYmFpJTIwYWlycG9ydHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 92, value: 90, partnership: 88 }, peerReviews: [] },
            { id: 'SUP_09', type: 'Supplier', name: "Varanasi Boat Tours", rating: 4.7, reviews: 85, trustScore: 91, service: "Activity", verified: false, img: 'https://images.unsplash.com/photo-1544272714-03a1d4b46c82?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8dmFyYW5hc2klMjBib2F0fGVufDB8fDB8fHww&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 90, value: 92, partnership: 90 }, peerReviews: [] },
            { id: 'SUP_10', type: 'Supplier', name: "Rajasthan Luxury Stays", rating: 4.9, reviews: 115, trustScore: 96, service: "Accommodation", verified: true, img: 'https://images.unsplash.com/photo-1593332147738-d74c0c160533?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cmFqYXN0aGFuJTIwaG90ZWx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=300&q=80', analytics: { reliability: 97, value: 95, partnership: 96 }, peerReviews: [] },
        ],
        clients: [
            // 10+ Clients
            { id: 'C_01', name: "Sharma Family", totalBookings: 5, totalSpend: 875000, lastTrip: "Goa", communication: [{date: '2025-09-01', log: 'Sent quote for Manali trip.', by: 'Rajesh Kumar'}, {date: '2025-08-28', log: 'Inquiry call for winter vacation.', by: 'Rajesh Kumar'}] },
            { id: 'C_02', name: "Jain Corporation", totalBookings: 12, totalSpend: 4520000, lastTrip: "Corporate Retreat", communication: [{date: '2025-09-05', log: 'Confirmed booking for Agra offsite.', by: 'Priya S.'}, {date: '2025-09-02', log: 'Finalized payment terms.', by: 'Rajesh Kumar'}] },
            { id: 'C_03', name: "Mr. Patel", totalBookings: 1, totalSpend: 85000, lastTrip: "Udaipur", communication: [{date: '2025-10-07', log: 'Confirmed Udaipur trip.', by: 'Rajesh Kumar'}] },
            { id: 'C_04', name: "Gupta Group", totalBookings: 2, totalSpend: 310000, lastTrip: "Kerala", communication: [{date: '2025-10-08', log: 'Sent Kerala quote.', by: 'Priya S.'}] },
            { id: 'C_05', name: "Mehta Couple", totalBookings: 3, totalSpend: 420000, lastTrip: "Andaman", communication: [{date: '2025-09-20', log: 'Completed Andaman trip.', by: 'Operations Team'}] },
            { id: 'C_06', name: "Verma Partners", totalBookings: 1, totalSpend: 95000, lastTrip: "Manali", communication: [{date: '2025-10-01', log: 'Sent payment reminder.', by: 'Finance Team'}] },
            { id: 'C_07', name: "Singh & Sons", totalBookings: 1, totalSpend: 0, lastTrip: "Rajasthan (Inquiry)", communication: [{date: '2025-10-10', log: 'New inquiry received.', by: 'System'}] },
            { id: 'C_08', name: "Ahuja Textiles", totalBookings: 4, totalSpend: 1250000, lastTrip: "Kashmir", communication: [{date: '2025-10-09', log: 'Confirmed Kashmir booking.', by: 'Priya S.'}] },
            { id: 'C_09', name: "Dr. Reddy", totalBookings: 1, totalSpend: 0, lastTrip: "Ooty (Quoted)", communication: [{date: '2025-10-10', log: 'Sent Ooty quote.', by: 'Amit P.'}] },
            { id: 'C_10', name: "Goa Getaway Group", totalBookings: 2, totalSpend: 280000, lastTrip: "Goa", communication: [{date: '2025-10-10', log: 'Trip in progress.', by: 'Sunita M.'}] },
            { id: 'C_11', name: "Himalayan Trekkers", totalBookings: 1, totalSpend: 0, lastTrip: "Sikkim (Inquiry)", communication: [{date: '2025-10-10', log: 'New inquiry for Sikkim.', by: 'System'}] },
        ],
        analyticsData: {
            revenue: [18, 22, 25, 23, 28, 32], revenueLabels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep"],
            bookingsByDest: [45, 30, 15, 10], bookingsByDestLabels: ["Goa", "Manali", "Kerala", "Udaipur"],
            pricingAnalysis: { 'PKG_MANALI_01': { baseCost: 75000, marketAvg: 98000, recommended: 96500 } }
        },
        liveTripData: {
            'BK103': { news: [], weather: { temp: '28°C', condition: 'Sunny' }, alerts: [], checklist: [] },
            'BK104': { news: ["Taj Mahal partially closed for cleaning 10am-12pm."], weather: { temp: '32°C', condition: 'Clear Skies' }, alerts: ["Flight Cancelled"], checklist: [] },
            'BK106': { news: [], weather: { temp: '3°C', condition: 'Partly Cloudy' }, alerts: [], checklist: [] },
            'BK110': { news: ["Calangute beach reported high tides, advise caution."], weather: { temp: '29°C', condition: 'Partly Cloudy' }, alerts: [], checklist: [] },
        },
        aiRecommendations: {
            "Manali": [
                { id: 'REC_01', title: 'Local Himachali Food Tour', details: 'Experience authentic local cuisine.', price: 5000 },
                { id: 'REC_02', title: 'Adventure Sports Pass', details: 'Includes paragliding and river rafting.', price: 8000 },
            ],
            "Goa": [
                { id: 'REC_05', title: 'Dudhsagar Falls Day Trip', details: 'Full day trip to the famous waterfalls.', price: 6000 },
                { id: 'REC_06', title: 'Private Yacht Cruise', details: '3-hour sunset cruise.', price: 15000 },
            ],
            "Default": [
                { id: 'REC_03', title: 'City Walking Tour', details: 'Discover hidden gems with a local guide.', price: 3000 },
                { id: 'REC_04', title: 'Private Airport Transfer', details: 'Comfortable and reliable pickup.', price: 2500 },
            ]
        },
        // NEW: Contextual Help Data
        contextualHelp: {
            "dashboard": {
                title: "How to use the Dashboard",
                content: `
                    <p class"text-muted">Your dashboard is your new command center, giving you a 10,000-foot view of your business.</p>
                    <ul class="prose prose-sm max-w-none text-muted">
                        <li><b>Global Search:</b> Use the top bar to search for anything: packages, clients, hotels, or suppliers.</li>
                        <li><b>AI Opportunities:</b> This feed analyzes market trends and client history to suggest actions that can increase your revenue.</li>
                        <li><b>Performance:</b> Quickly track your monthly revenue goal and see key stats like bookings, margin, and response time.</li>
                        <li><b>Action Items:</b> This shows you urgent tasks like overdue payments, unassigned inquiries, and upcoming departures.</li>
                    </ul>
                `
            },
            "bookings": {
                title: "How to use Bookings",
                content: `
                    <p class="text-muted">The Bookings page is your pipeline. It helps you manage every trip from initial inquiry to completion.</p>
                    <ul class="prose prose-sm max-w-none text-muted">
                        <li><b>Kanban View (Desktop):</b> Drag and drop bookings between columns to update their status.</li>
                        <li><b>Tab View (Mobile):</b> Tap a status tab (e.g., "Inquiry", "Quoted") to see all bookings in that stage.</li>
                        <li><b>Quick Actions (Mobile):</b> On any booking card, **swipe left** to reveal quick actions like "Log Payment" or "Call Client".</li>
                        <li><b>Filters:</b> Use the "Filter & Sort" button to find specific bookings, such as high-value trips or unassigned inquiries.</li>
                    </ul>
                `
            },
            "search": {
                title: "How to use Search",
                content: `
                    <p class="text-muted">This is your central hub for finding any resource you need. The new search is designed to be a complete workflow.</p>
                    <ul class="prose prose-sm max-w-none text-muted">
                        <li><b>Global AI Search:</b> Type anything (e.g., "luxury goa hotel with pool" or "BK101" or "Sharma Family") to find all related items.</li>
                        <li><b>Recent Searches:</b> Tap a pill to instantly run a previous search.</li>
                        <li><b>Browse by Category:</b> Use these cards for inspiration or to quickly find packages for common themes like "Beach" or "Hills".</li>
                        <li><b>List / Map View:</b> On the results page, toggle between List and Map view to see property locations.</li>
                        <li><b>Card Actions:</b> On any result card, you can:
                            <ul class="!text-muted">
                                <li><i class="ph-bookmark-simple"></i> <b>Save:</b> Adds the item to your "Saved Items" page.</li>
                                <li><i class="ph-arrows-left-right"></i> <b>Compare:</b> Adds the item to the compare tool.</li>
                                <li><i class="ph-plus"></i> <b>Quick Add:</b> Adds the item to a temporary "Quick Itinerary".</li>
                            </ul>
                        </li>
                    </ul>
                `
            },
            "saved": {
                title: "How to use Saved Items",
                content: `
                    <p class="text-muted">This is your personal library of your favorite packages, hotels, and suppliers. Save items from Search to review them later.</p>
                    <ul class="prose prose-sm max-w-none text-muted">
                        <li><b>Tabs:</b> Quickly switch between your saved Packages, Hotels, Flights, and Suppliers.</li>
                        <li><b>Compare Tool:</b> Select two or more items of the same type (e.g., 3 hotels) by clicking the <i class="ph-arrows-left-right"></i> icon. Then, click the "Compare" button to see a side-by-side breakdown.</li>
                        <li><b>Quick Add:</b> You can add items directly from here to your "Quick Itinerary" just like from the search page.</li>
                    </ul>
                `
            },
            "default": {
                title: "How to Use This Page",
                content: "<p class='text-muted'>This is a new feature. Help content for this specific page is coming soon!</p>"
            }
        }
    };
    // ========================================================================
    // ========================= APP LOGIC (START) ==========================
    // ========================================================================
    const app = {
        // Elements
        loginPage: null, mainPage: null, loginButton: null, mainContent: null,
        headerTitle: null, crisisAlertIcon: null, modalContainer: null,
        toastContainer: null, profileButton: null, backButton: null,
        breadcrumbContainer: null, mainHeader: null, bottomNavLinks: null,
        desktopSidebarLinks: null,
        fab: null, fabActions: null,
        helpFab: null,
        createMenuButton: null,
        createMenuDropdown: null,
        quickItinBar: null,
        quickItinCount: null,
        charts: {},
        // State
        currentView: 'dashboard',
        bookingStatusTab: 'In-Progress',
        clientsTab: 'Active',
        teamHubTab: 'Performance', // This will be ignored on desktop
        savedTab: 'packages',
        searchView: 'List', // 'List' or 'Map'
        navigationContext: {},
        navigationHistory: [],
        currentItinerary: null,
        newBookingState: { step: 1, data: {} },
        bookingFilters: { assignedTo: 'all', actionRequired: false, highValue: false },
        bookingSort: 'travelDate',
        searchFilters: {
            type: 'all', // 'all', 'package', 'hotel', 'flight', 'supplier'
            priceRange: null, // [min, max]
            rating: 0, // 0-5
            amenities: [], // ['Pool', 'Spa']
            stops: null // 0, 1, 2 (for flights)
        },
        savedItems: {
            packages: new Set(['PKG_MANALI_01']),
            hotels: new Set(['HOTEL_GOA_01']),
            flights: new Set(),
            suppliers: new Set(['SUP_01', 'SUP_02'])
        },
        compareItems: [], // [{id: 'PKG_GOA_01', type: 'package'}, {id: 'PKG_GOA_02', type: 'package'}]
        quickItinerary: [], // [{id: 'PKG_MANALI_01', type: 'package'}, {id: 'HOTEL_MANALI_02', type: 'hotel'}]
        pageTitles: {
            dashboard: "Dashboard", bookings: "Bookings", search: "Search",
            marketplace: "Deals Marketplace", more: "More",
            trust_hub: "Trust Hub", clients: "Clients", finance: "Finance",
            analytics: "Analytics", profile: "My Profile", walkthrough: "How to Use",
            team_hub: "Team Hub", staff_details: "Staff Performance",
            supplier_details: "Supplier Details", client_details: "Client Details",
            trip_dashboard: "Live Trip Dashboard", booking_details: "Booking Details",
            search_results: "Search Results", itinerary_builder: "Itinerary Builder",
            custom_itinerary_builder: "Custom Itinerary",
            crisis: "Crisis Management",
            saved: "Saved Items",
            compare: "Compare Items"
        },
        init() {
            this.loginPage = document.getElementById('page-login');
            this.mainPage = document.getElementById('page-main');
            this.loginButton = document.getElementById('login-button');
            this.mainContent = document.getElementById('main-content');
            this.headerTitle = document.getElementById('header-title');
            this.crisisAlertIcon = document.getElementById('crisis-alert-icon');
            this.modalContainer = document.getElementById('modal-container');
            this.toastContainer = document.getElementById('toast-container');
            this.profileButton = document.getElementById('profile-button');
            this.backButton = document.getElementById('back-button');
            this.breadcrumbContainer = document.getElementById('breadcrumb-container');
            this.mainHeader = document.getElementById('main-header');
            // Nav Links
            this.bottomNavLinks = document.querySelectorAll('footer .bottom-nav-link');
            this.desktopSidebarLinks = document.querySelectorAll('#desktop-sidebar .bottom-nav-link');
            // FABs
            this.fab = document.getElementById('fab');
            this.fabActions = document.getElementById('fab-actions');
            this.helpFab = document.getElementById('help-fab');
            // Desktop Create Menu
            this.createMenuButton = document.getElementById('create-menu-button');
            this.createMenuDropdown = document.getElementById('create-menu-dropdown');
            // Quick Itinerary Bar
            this.quickItinBar = document.getElementById('quick-itinerary-bar');
            this.quickItinCount = document.getElementById('quick-itin-count');
            
            // --- Event Listeners ---
            this.loginButton.addEventListener('click', () => this.login());
            this.backButton.addEventListener('click', () => this.goBack());
            // Nav listeners
            this.bottomNavLinks.forEach(link => link.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view)));
            this.desktopSidebarLinks.forEach(link => link.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view)));
            // Header button listeners
            this.crisisAlertIcon.addEventListener('click', () => this.navigate('crisis'));
            this.profileButton.addEventListener('click', () => this.navigate('profile'));
            // FAB listeners
            if(this.fab) this.fab.addEventListener('click', () => this.toggleFab()); // Mobile FAB
            // FIX: Call contextual help
            if(this.helpFab) this.helpFab.addEventListener('click', (e) => this.showContextualHelp()); // Help FAB
            // Desktop Create Menu listener
            if(this.createMenuButton) this.createMenuButton.addEventListener('click', () => this.toggleCreateMenu());

            // Centralized event listener for all dynamic actions
            document.body.addEventListener('click', (e) => {
                // Handle modal clicks
                if (this.modalContainer && !this.modalContainer.classList.contains('hide')) {
                    this.handleModalClick(e);
                    // Clicks inside a modal should not trigger "outside" clicks below
                    return; 
                }
                
                // Handle main content clicks
                if (this.mainContent && this.mainContent.contains(e.target)) {
                    this.handleMainContentClick(e);
                }

                // Handle header clicks (for breadcrumbs)
                if (this.mainHeader && this.mainHeader.contains(e.target)) {
                    this.handleHeaderClick(e);
                    // Prevent header clicks from triggering "outside" click handlers
                    if (e.target.closest('#profile-button') || e.target.closest('#crisis-alert-icon') || e.target.closest('#create-menu-container')) {
                        return;
                    }
                }
                
                // Handle Create Menu Dropdown Clicks
                if (this.createMenuDropdown && this.createMenuDropdown.contains(e.target)) {
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget) {
                        const { action } = actionTarget.dataset;
                        if (action === 'newBooking') this.showNewBookingModal();
                        if (action === 'newItinerary') this.showClientSelectionForItinerary(null);
                        this.toggleCreateMenu(false); // Close menu
                    }
                    return; // Click was inside dropdown
                }

                // Handle sidebar clicks (LOGOUT ONLY)
                const sidebar = document.getElementById('desktop-sidebar');
                if (sidebar && sidebar.contains(e.target)) {
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget) {
                        const { action } = actionTarget.dataset;
                        if (action === 'logout') window.location.reload();
                    }
                }

                // Handle FAB clicks (Mobile Create)
                const fabContainer = document.getElementById('fab-container');
                if (fabContainer && fabContainer.contains(e.target)) {
                    // This logic is for the main FAB, not the help FAB
                    if (e.target.closest('#fab')) {
                        // This is handled by the #fab listener, so we can ignore
                    } else {
                        const fabActionTarget = e.target.closest('[data-action]');
                        if (fabActionTarget) {
                            const { action } = fabActionTarget.dataset;
                            if (action === 'newBooking') {
                                this.showNewBookingModal();
                                this.toggleFab(false);
                            }
                            if (action === 'newItinerary') {
                                this.showClientSelectionForItinerary(null);
                                this.toggleFab(false);
                            }
                        }
                    }
                    return; // Click was in FAB container
                }
                
                // Handle Help FAB click
                if (e.target.closest('#help-fab')) {
                    // This is handled by the #help-fab listener
                    return;
                }
                
                // Handle Quick Itinerary Bar click
                const quickItinTarget = e.target.closest('#quick-itinerary-bar');
                if (quickItinTarget) {
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget && actionTarget.dataset.action === 'reviewQuickItinerary') {
                        this.showQuickItineraryModal();
                    }
                    return;
                }
                
                // --- Outside Click Handlers ---
                
                // Close Create Menu if clicking outside
                const createContainer = document.getElementById('create-menu-container');
                if (createContainer && !createContainer.contains(e.target) && this.createMenuDropdown && !this.createMenuDropdown.classList.contains('hide')) {
                    this.toggleCreateMenu(false);
                }

                // Close (Mobile) FAB if clicking outside
                if (this.fab && this.fab.classList.contains('open') && !e.target.closest('#fab-container')) {
                    this.toggleFab(false);
                }
            });

            this.mainContent.addEventListener('input', (e) => this.handleMainContentInput(e));
            this.initSwipeActions();
            setInterval(() => {
                document.querySelectorAll('.countdown-timer').forEach(timer => {
                    const expiration = parseInt(timer.dataset.expiration, 10);
                    const now = new Date().getTime();
                    const distance = expiration - now;
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timer.textContent = `Ends in: ${hours}h ${minutes}m ${seconds}s`;
                    if (distance < 0) timer.textContent = "EXPIRED";
                });
            }, 1000);
            setTimeout(() => this.crisisAlertIcon.classList.remove('hide'), 5000);
            // Set default tooltip styles for Chart.js
            Chart.defaults.plugins.tooltip.enabled = true;
            Chart.defaults.plugins.tooltip.mode = 'index';
            Chart.defaults.plugins.tooltip.intersect = false;
            Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.85)'; // slate-900 approx
            Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
            Chart.defaults.plugins.tooltip.bodyColor = '#ffffff';
            Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.1)';
            Chart.defaults.plugins.tooltip.borderWidth = 1;
            Chart.defaults.plugins.tooltip.padding = 10;
            Chart.defaults.plugins.tooltip.cornerRadius = 8; // var(--radius-sm)
            Chart.defaults.plugins.tooltip.usePointStyle = true;
        },
        handleHeaderClick(e) {
            const target = e.target.closest('[data-action="jumpTo"]');
            if (target) this.jumpTo(target.dataset.index);
        },
        handleMainContentClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const params = { ...target.dataset };

            // Accordion Toggle
            if (params.action === 'toggleAccordion') {
                const content = target.nextElementSibling;
                const icon = target.querySelector('i.ph-caret-down');
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = '0px';
                    content.classList.remove('open');
                    target.classList.remove('open');
                    if (icon) icon.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    content.classList.add('open');
                    target.classList.add('open');
                    if (icon) icon.classList.add('rotate-180');
                }
                return;
            }

            // All other actions
            switch (params.action) {
                case 'navigate': if (params.view) this.navigate(params.view, params); break;
                // Search Actions
                case 'globalSearch': this.performGlobalSearch(); break;
                case 'runRecentSearch': this.performGlobalSearch(params.query); break;
                case 'runCategorySearch': this.performGlobalSearch(params.query); break;
                case 'showSearchFilters': this.showSearchFiltersModal(); break;
                case 'setSearchView': this.searchView = params.view; this.render(); break;
                case 'toggleSaveItem': this.toggleSaveItem(params.id, params.type); break;
                case 'toggleCompareItem': this.toggleCompareItem(params.id, params.type, target); break;
                case 'toggleQuickItinItem': this.toggleQuickItinItem(params.id, params.type, target); break;
                case 'showCompareModal': this.showCompareModal(); break;
                // Tab Changes
                case 'changeBookingStatusTab': this.bookingStatusTab = params.status; this.render(); break;
                case 'changeClientsTab': this.clientsTab = params.tab; this.render(); break;
                case 'changeTeamHubTab': this.teamHubTab = params.tab; this.render(); break;
                case 'changeSavedTab': this.savedTab = params.tab; this.render(); break;
                // Booking & Itinerary Actions
                case 'buildItinerary': this.showClientSelectionForItinerary(params.packageId); break;
                case 'buildQuoteFromInquiry': this.navigate('search_results', { fromInquiry: true, bookingId: params.bookingId, query: params.destination }); break;
                case 'createCustomItinerary': this.createCustomItinerary(params.bookingId); break;
                case 'addItineraryAddon': this.addItineraryAddon(params.addonId); break;
                case 'showHotelOptions': this.showHotelOptions(parseInt(params.dayIndex, 10)); break;
                case 'generateQuote': this.generateQuote(); break;
                case 'generateInvoice': this.generateInvoice(params.bookingId); break;
                case 'logPayment': this.showLogPaymentModal(params.bookingId); break;
                case 'showAssignModal': this.showAssignModal(params.bookingId); break;
                case 'showEditBookingModal': this.showEditBookingModal(params.bookingId); break;
                case 'addDayToCustomItinerary': this.addDayToCustomItinerary(); break;
                case 'searchHotels': this.navigate('search_results', { fromCustomItinerary: true, query: 'hotels' }); break;
                case 'searchFlights': this.navigate('search_results', { fromCustomItinerary: true, query: 'flights' }); break;
                case 'addTransport': this.showToast("Adding Transport component..."); break;
                case 'addActivity': this.showToast("Adding Activity component..."); break;
                // Other Actions
                case 'submitReview': this.submitReview(params.supplierId); break;
                case 'generateChecklist': this.generateChecklist(params.bookingId); break;
                case 'setReminder': this.showToast(`Reminder set for ${params.clientName}`); break;
                case 'logout': window.location.reload(); break;
                case 'showLeaderboard': this.showLeaderboardModal(); break;
                case 'optimizeItinerary': this.optimizeItinerary(); break;
                case 'draftCrisisUpdate': this.draftCrisisUpdate(); break;
                case 'askLocalExpert': this.askLocalExpert(); break;
                case 'addNewStaff': this.showAddStaffModal(); break;
            }
        },
        handleMainContentInput(e) {
            const target = e.target;
            if (target.id === 'pricing-optimizer-slider') {
                this.updatePricingOptimizer(target.value);
            }
            // Live search on desktop search bar
            if (target.id === 'global-search-input' && window.innerWidth >= 1024) {
                 this.performGlobalSearch(target.value, true); // Pass true for live search
            }
        },
        handleModalClick(e) {
            const target = e.target.closest('[data-action]');
            // Handle clicking the overlay to close
            if (e.target.classList.contains('modal-overlay') && e.target.dataset.action === 'closeModal') {
                this.closeModal();
                return;
            }
            if (!target) return;
            const params = { ...target.dataset };
            switch(params.action) {
                case 'closeModal': this.closeModal(); break;
                case 'sendQuote': this.sendQuote(); break;
                case 'selectHotel': this.selectHotel(parseInt(params.dayIndex, 10), params.hotelId); break;
                case 'submitPayment': this.logPayment(params.bookingId); break;
                case 'nextBookingStep': this.handleNewBookingStep('next'); break;
                case 'prevBookingStep': this.handleNewBookingStep('prev'); break;
                case 'createBooking': this.createBooking(); break;
                case 'assignToTeam': this.assignToTeam(params.bookingId, params.teamName); break;
                case 'selectClientForItinerary': this.selectClientForItinerary(params.packageId, params.bookingId); break;
                case 'updateBookingDetails': this.updateBookingDetails(params.bookingId); break;
                case 'applyBookingFilters': this.applyBookingFilters(); break;
                case 'applySearchFilters': this.applySearchFilters(); break;
                case 'saveNewStaff': this.saveNewStaff(); break;
                case 'finalizeQuickItinerary': this.finalizeQuickItinerary(); break;
            }
        },
        login() {
            this.loginPage.classList.add('hide');
            this.mainPage.classList.remove('hide');
            this.navigate('dashboard');
        },
        navigate(view, context = {}, isBack = false) {
            // Top level views for navigation history reset
            const topLevelViews = ['dashboard', 'bookings', 'search', 'marketplace', 'more', 'saved'];
            const desktopTopLevel = ['team_hub', 'clients', 'trust_hub', 'finance', 'analytics', 'walkthrough'];
            const allTopLevelViews = [...topLevelViews, ...desktopTopLevel];
            
            const isTopLevelNav = allTopLevelViews.includes(view);
            if (!isBack) {
                if (isTopLevelNav) {
                    this.navigationHistory = [];
                } else {
                    if(!(this.currentView === view && JSON.stringify(this.navigationContext) === JSON.stringify(context))) {
                        this.navigationHistory.push({ view: this.currentView, context: this.navigationContext });
                    }
                }
            }
            this.currentView = view;
            this.navigationContext = context;
            
            if (view === 'search_results') {
                this.searchView = 'List'; // Default to list view on new search
                this.compareItems = []; // Clear compare on new search
            }
            if (view === 'itinerary_builder' && !this.currentItinerary) {
                const packageId = context.packageId || 'PKG_MANALI_01';
                const bookingId = context.bookingId;
                this.buildItinerary(packageId, bookingId);
            }
            this.updateNav();
            this.render();
            document.getElementById('main-content').scrollTo(0, 0);
            this.toggleFab(false);
        },
        goBack() {
            if (this.navigationHistory.length > 0) {
                const lastState = this.navigationHistory.pop();
                this.navigate(lastState.view, lastState.context, true);
            }
        },
        jumpTo(index) {
            index = parseInt(index, 10);
            if (index === -1) { // Dashboard link
                this.navigationHistory = [];
                this.navigate('dashboard', {}, true);
            } else if (this.navigationHistory[index]) {
                const targetState = this.navigationHistory[index];
                this.navigationHistory = this.navigationHistory.slice(0, index);
                this.navigate(targetState.view, targetState.context, true);
            }
        },
        getPageTitle: (view) => app.pageTitles[view] || "Page",
        updateNav() {
            this.headerTitle.textContent = this.getPageTitle(this.currentView);
            let mainView = this.currentView;
            // Find the top-level parent view
            const allTopLevelViews = ['dashboard', 'bookings', 'search', 'marketplace', 'more', 'saved', 'team_hub', 'clients', 'trust_hub', 'finance', 'analytics', 'walkthrough'];
            if(!allTopLevelViews.includes(mainView)) {
                // Look back in history for the last top-level view
                const lastTopLevel = [...this.navigationHistory].reverse().find(s => allTopLevelViews.includes(s.view));
                mainView = lastTopLevel ? lastTopLevel.view : 'dashboard'; // Default to dashboard if no history found
            }
            // Update mobile nav
            this.bottomNavLinks.forEach(link => link.classList.toggle('active', link.dataset.view === mainView));
            // Update desktop nav
            if (this.desktopSidebarLinks) {
                this.desktopSidebarLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.view === mainView);
                });
            }
            if (this.currentView === 'crisis') {
                this.crisisAlertIcon.classList.add('hide');
            }
            this.breadcrumbContainer.innerHTML = '';
            if (this.navigationHistory.length > 0) {
                this.backButton.classList.remove('hide');
                const links = [`<a href="#" class="hover:underline" data-action="jumpTo" data-index="-1">Home</a>`];
                this.navigationHistory.forEach((state, index) => {
                    links.push(`<span class="mx-1 opacity-50">/</span><a href="#" class="hover:underline" data-action="jumpTo" data-index="${index}">${this.getPageTitle(state.view)}</a>`);
                });
                this.breadcrumbContainer.innerHTML = links.join('');
                this.headerTitle.classList.add('mt-1');
            } else {
                this.backButton.classList.add('hide');
                this.headerTitle.classList.remove('mt-1');
            }
        },
        render() {
            // Destroy existing charts before rendering new view
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            this.charts = {}; // Clear the charts object
            const viewRenderer = `render_${this.currentView}`;
            if (this.mainContent) {
                this.mainContent.innerHTML = this[viewRenderer] ? this[viewRenderer]() : this._renderComingSoon(this.getPageTitle(this.currentView));
                this.mainContent.classList.remove('animate-fade-in');
                void this.mainContent.offsetWidth; // Trigger reflow
                this.mainContent.classList.add('animate-fade-in');
            }
            // Re-render charts *after* the view HTML is in the DOM
            if (this.currentView === 'analytics') this.renderCharts();
            // FIX: Ensure this is called AFTER render
            if (this.currentView === 'supplier_details') this.renderSupplierPeerReviewChart();
            if (this.currentView === 'staff_details') this.renderStaffPerformanceChart();
            if (this.currentView === 'team_hub' && (mockData.user.role === 'Admin' || mockData.user.role === 'Manager')) this.renderTeamHubCharts();
        },
        openModal(content) {
            this.modalContainer.classList.remove('hide');
            this.modalContainer.innerHTML = `<div class="modal-overlay fixed inset-0" data-action="closeModal"></div>` + content;
            // Animate modal content
            setTimeout(() => {
                const modalContentEl = this.modalContainer.querySelector('.modal-content');
                if (modalContentEl) modalContentEl.classList.add('open');
            }, 10);
        },
        closeModal() {
            const modalContent = this.modalContainer.querySelector('.modal-content');
            const overlay = this.modalContainer.querySelector('.modal-overlay');
            
            const animationDuration = 300;
            if (modalContent) modalContent.style.animation = `fadeOut ${animationDuration}ms ease-out forwards`;
            if (overlay) overlay.style.animation = `fadeOut ${animationDuration}ms ease-out forwards`;
            
            setTimeout(() => {
                this.modalContainer.classList.add('hide');
                this.modalContainer.innerHTML = '';
            }, animationDuration);
        },
        toggleFab(force) {
            if (!this.fab) return;
            const isOpen = this.fab.classList.contains('open');
            const icon = this.fab.querySelector('i');
            if (force === false || isOpen) {
                this.fab.classList.remove('open');
                if (icon) icon.classList.remove('rotate-45');
                this.fabActions.classList.remove('open');
            } else if(force === true || !isOpen) {
                this.fab.classList.add('open');
                if (icon) icon.classList.add('rotate-45');
                this.fabActions.classList.add('open');
            }
        },
        toggleCreateMenu(force) {
            if (!this.createMenuDropdown) return;
            const isOpen = !this.createMenuDropdown.classList.contains('hide');
            if (force === false || isOpen) {
                this.createMenuDropdown.classList.add('hide');
            } else if (force === true || !isOpen) {
                this.createMenuDropdown.classList.remove('hide');
            }
        },
        // NEW: Contextual Help Modal
        showContextualHelp() {
            const helpData = mockData.contextualHelp[this.currentView] || mockData.contextualHelp['default'];
            const modalContent = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">${helpData.title}</h3>
                        <button data-action="closeModal" class="btn-secondary !p-2 !w-9 !h-9"><i class="ph-x text-xl"></i></button>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto -mx-4 px-4 text-muted">
                        ${helpData.content}
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button data-action="closeModal" class="btn-primary">Got it!</button>
                    </div>
                </div>`;
            this.openModal(modalContent);
        },
        initSwipeActions() {
            let startX = 0;
            let currentX = 0;
            let activeElement = null;
            let actionsWidth = 160; // Default width
            this.mainContent.addEventListener('touchstart', (e) => {
                const contentTarget = e.target.closest('.swipe-content');
                // Close any other open swipe actions first
                document.querySelectorAll('.swipe-content[style*="transform: translateX"]').forEach(el => {
                    if (el !== contentTarget) {
                        el.style.transition = 'transform 0.3s ease';
                        el.style.transform = 'translateX(0)';
                    }
                });
                if (contentTarget) {
                    const actionsContainer = contentTarget.previousElementSibling;
                    if (actionsContainer && actionsContainer.classList.contains('swipe-actions')) {
                        actionsWidth = actionsContainer.offsetWidth; // Get actual width
                    } else {
                        actionsWidth = 160; // Fallback
                    }
                    startX = e.touches[0].clientX;
                    activeElement = contentTarget;
                    activeElement.style.transition = 'none'; // Disable transition during drag
                } else {
                    activeElement = null; // Reset if touch doesn't start on swipe content
                }
            }, { passive: true });
            this.mainContent.addEventListener('touchmove', (e) => {
                if (!activeElement) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                // Allow swiping right to close, but prevent swiping further right than 0
                if (diff > 0) {
                    activeElement.style.transform = `translateX(0)`;
                    return; // Don't allow swiping further right
                }
                // Allow swiping left up to the actions width
                if (diff < 0 && diff > -actionsWidth) {
                    activeElement.style.transform = `translateX(${diff}px)`;
                } else if (diff <= -actionsWidth) {
                    // Optional: Add slight resistance beyond the limit
                    const overSwipe = diff + actionsWidth;
                    activeElement.style.transform = `translateX(${-actionsWidth + overSwipe * 0.3}px)`;
                }
            }, { passive: true });
            this.mainContent.addEventListener('touchend', () => {
                if (!activeElement) return;
                const diff = currentX - startX;
                activeElement.style.transition = 'transform 0.3s ease'; // Re-enable transition
                if (diff < -60) { // Threshold to snap open
                    activeElement.style.transform = `translateX(-${actionsWidth}px)`;
                } else { // Snap closed
                    activeElement.style.transform = 'translateX(0)';
                }
                activeElement = null;
                startX = 0;
                currentX = 0;
            });
        },
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            // FIX: Use new semantic classes
            const toastTypeClass = type === 'success' ? 'toast-ok' : (type === 'error' ? 'toast-danger' : 'toast-info');
            toast.className = `toast text-white font-medium py-2 px-4 shadow-lg text-sm ${toastTypeClass}`;
            toast.textContent = message;
            this.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        },
        // ========================================================================
        // ========================= NEW SEARCH/SAVE FLOW =========================
        // ========================================================================
        performGlobalSearch(query, isLiveSearch = false) {
            let searchQuery = query;
            if (!searchQuery) {
                const input = document.getElementById('global-search-input') || document.getElementById('dashboard-search-input');
                if (input) searchQuery = input.value;
            }
            if (!searchQuery && !isLiveSearch) {
                this.showToast("Please enter a search term.", "error");
                return;
            }
            if (isLiveSearch && !searchQuery) {
                // Clear live search results if query is empty
                const resultsContainer = document.getElementById('search-results-container');
                if (resultsContainer) resultsContainer.innerHTML = '';
                return;
            }
            
            // If it's not a live search, navigate to the results page
            if (!isLiveSearch) {
                this.navigate('search_results', { query: searchQuery });
            } else {
                // Otherwise, render results directly into the current page
                const resultsContainer = document.getElementById('search-results-container');
                if (resultsContainer) {
                    const resultsHTML = this._renderSearchResultsHTML(searchQuery, true); // Pass true for snippet view
                    resultsContainer.innerHTML = resultsHTML;
                }
            }
        },
        runRecentSearch(query) {
            this.performGlobalSearch(query, false);
        },
        runCategorySearch(query) {
            this.performGlobalSearch(query, false);
        },
        clearSearchFilters() {
            this.searchFilters = { type: 'all', priceRange: null, rating: 0, amenities: [], stops: null };
            this.render(); // Re-render the search_results page
        },
        getSearchItemById(id, type) {
            const allItems = [
                ...mockData.searchResults,
                ...mockData.hotels,
                ...mockData.flights,
                ...mockData.suppliers
            ];
            // Find by type first, then ID.
            return allItems.find(item => item.id === id && item.type.toLowerCase() === type.toLowerCase());
        },
        toggleSaveItem(id, type) {
            const itemSet = this.savedItems[type.toLowerCase() + 's']; // e.g., 'packages'
            if (!itemSet) return;

            const btn = document.querySelector(`.card-action-btn.save[data-id="${id}"]`);
            if (itemSet.has(id)) {
                itemSet.delete(id);
                if (btn) btn.classList.remove('active');
                this.showToast("Item removed from saved.", "info");
            } else {
                itemSet.add(id);
                if (btn) btn.classList.add('active');
                this.showToast("Item saved!", "success");
            }
            // Re-render if we are on the saved page
            if (this.currentView === 'saved') this.render();
        },
        toggleCompareItem(id, type, btnElement) {
            const existingIndex = this.compareItems.findIndex(item => item.id === id);
            
            if (existingIndex > -1) {
                // Remove item
                this.compareItems.splice(existingIndex, 1);
                if (btnElement) btnElement.classList.remove('active');
            } else {
                // Check if item of the same type is already in compare
                if (this.compareItems.length > 0 && this.compareItems[0].type !== type) {
                    this.showToast("You can only compare items of the same type.", "error");
                    return;
                }
                if (this.compareItems.length >= 3) {
                    this.showToast("You can only compare up to 3 items.", "error");
                    return;
                }
                // Add item
                this.compareItems.push({ id, type });
                if (btnElement) btnElement.classList.add('active');
            }
            
            // Update compare button visibility
            const compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                if (this.compareItems.length > 1) {
                    compareBtn.classList.remove('hide');
                    compareBtn.querySelector('span').textContent = `Compare (${this.compareItems.length})`;
                } else {
                    compareBtn.classList.add('hide');
                }
            }
        },
        showCompareModal() {
            if (this.compareItems.length < 2) {
                this.showToast("Please select at least 2 items to compare.", "error");
                return;
            }
            this.navigate('compare');
        },
        toggleQuickItinItem(id, type, btnElement) {
            const existingIndex = this.quickItinerary.findIndex(item => item.id === id);
            
            if (existingIndex > -1) {
                // Remove item
                this.quickItinerary.splice(existingIndex, 1);
                if (btnElement) {
                    btnElement.classList.remove('active', 'btn-secondary-outline', 'quick-add-active');
                    btnElement.innerHTML = `<i class="ph-plus text-lg"></i>`;
                }
            } else {
                // Add item
                const item = this.getSearchItemById(id, type);
                if (item) {
                    this.quickItinerary.push(item);
                    if (btnElement) {
                        btnElement.classList.add('active');
                        // Handle special case for outline button
                        if(btnElement.classList.contains('btn-secondary-outline')) {
                            btnElement.classList.add('quick-add-active');
                        }
                        btnElement.innerHTML = `<i class="ph-check text-lg"></i>`;
                    }
                }
            }
            this.updateQuickItineraryBar();
        },
        updateQuickItineraryBar() {
            if (!this.quickItinBar || !this.quickItinCount) return;
            
            if (this.quickItinerary.length > 0) {
                this.quickItinCount.textContent = `${this.quickItinerary.length} item${this.quickItinerary.length > 1 ? 's' : ''} added`;
                this.quickItinBar.classList.add('visible');
            } else {
                this.quickItinBar.classList.remove('visible');
            }
        },
        showQuickItineraryModal() {
            const itemsHTML = this.quickItinerary.map(item => `
                <div class="quick-itin-item-list">
                    <img src="${item.img || 'https://placehold.co/40x40/f1f5f9/475569?text=?'}" class="w-10 h-10 rounded-md object-cover mr-3 flex-shrink-0" alt="${item.title || item.name}" onerror="this.src='https://placehold.co/40x40/f1f5f9/475569?text=?'">
                    <div class="flex-1">
                        <p class="text-sm font-semibold leading-tight">${item.title || item.name}</p>
                        <p class="text-xs text-muted leading-tight">${item.type} | ${item.type === 'Flight' ? `${item.from} → ${item.to}` : (item.destination || `₹${item.price.toLocaleString('en-IN')}`)}</p>
                    </div>
                    <button data-action="toggleQuickItinItem" data-id="${item.id}" data-type="${item.type}" class="btn-secondary-outline !p-0 !w-8 !h-8 !rounded-full text-danger"><i class="ph-x"></i></button>
                </div>
            `).join('');

            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Review Quick Itinerary</h3>
                    <div class="space-y-2 max-h-[50vh] overflow-y-auto -mx-4 px-4">
                        ${itemsHTML.length > 0 ? itemsHTML : '<p class="text-muted text-sm text-center py-4">No items added yet.</p>'}
                    </div>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button data-action="closeModal" class="btn-secondary-outline">Keep Adding</button>
                        <button data-action="finalizeQuickItinerary" class="btn-primary" ${this.quickItinerary.length === 0 ? 'disabled' : ''}>Create Itinerary</button>
                    </div>
                </div>`;
            this.openModal(modalContent);
        },
        finalizeQuickItinerary() {
            // This is the new entry point to the itinerary builder flow
            // For now, it just clears the quick itinerary and navigates
            const clientName = "New Quick Build";
            this.currentItinerary = {
                title: `Custom Trip for ${clientName}`,
                clientName: clientName,
                bookingId: null,
                dayWisePlan: [
                    { day: 1, title: "Arrival & Check-in", activities: [], hotelId: null, flightId: null, items: [] }
                ],
                price: 0, baseCost: 0, addons: [], profit: 0, margin: 0,
                totalPrice: 0,
                // Add the new items
                components: [...this.quickItinerary]
            };
            
            // Clear the quick itinerary
            this.quickItinerary.forEach(item => {
                const btn = document.querySelector(`.card-action-btn.quick-add[data-id="${item.id}"]`);
                if(btn) btn.classList.remove('active');
            });
            this.quickItinerary = [];
            this.updateQuickItineraryBar();
            
            this.closeModal();
            this.navigate('custom_itinerary_builder');
        },
        // ========================================================================
        // ========================= BOOKING/ITINERARY FLOW =======================
        // ========================================================================
        buildItinerary(packageId, bookingId = null) {
            const packageData = mockData.searchResults.find(p => p.id === packageId);
            if (!packageData) return;
            this.currentItinerary = JSON.parse(JSON.stringify(packageData));
            this.currentItinerary.totalPrice = this.currentItinerary.price;
            this.currentItinerary.addons = [];
            if(bookingId && bookingId !== 'new') {
                const booking = mockData.bookings.find(b => b.id === bookingId);
                this.currentItinerary.clientName = booking ? booking.client : "Selected Client";
                this.currentItinerary.bookingId = booking ? booking.id : null;
            } else if (bookingId === 'new') {
                this.currentItinerary.clientName = "New Client";
            } else {
                 const booking = mockData.bookings.find(b => b.packageId === packageId);
                 if(booking) {
                    this.currentItinerary.clientName = booking.client;
                    this.currentItinerary.bookingId = booking.id;
                 } else {
                    this.currentItinerary.clientName = "New Client";
                 }
            }
            this.updateItineraryProfit();
        },
        addItineraryAddon(addonId) {
            const destination = this.currentItinerary.destination || "Default";
            const addonPool = mockData.aiRecommendations[destination] || mockData.aiRecommendations.Default;
            const addon = addonPool.find(rec => rec.id === addonId);
            
            if (this.currentItinerary && addon && !this.currentItinerary.addons.find(a => a.id === addonId)) {
                this.currentItinerary.addons.push(addon);
                this.currentItinerary.totalPrice += addon.price;
                this.updateItineraryProfit();
                this.showToast('Add-on added to itinerary!', 'success');
                this.render();
            }
        },
        updateItineraryProfit() {
            if (!this.currentItinerary) return;
            const baseCost = this.currentItinerary.baseCost || 0;
            const addonsCost = this.currentItinerary.addons.reduce((sum, addon) => sum + (addon.price * 0.8), 0); // Assuming 80% cost for addons
            const totalCost = baseCost + addonsCost;
            const profit = this.currentItinerary.totalPrice - totalCost;
            const margin = this.currentItinerary.totalPrice > 0 ? (profit / this.currentItinerary.totalPrice * 100).toFixed(1) : 0;
            this.currentItinerary.profit = profit;
            this.currentItinerary.margin = margin;
        },
        generateQuote() {
            if (!this.currentItinerary) {
                this.showToast("No itinerary to quote.", "error");
                return;
            }
            this.showToast("Quote Generated and Sent!", "success");
            if (this.currentItinerary.bookingId) {
                const booking = mockData.bookings.find(b => b.id === this.currentItinerary.bookingId);
                if (booking) {
                    booking.status = 'Quoted';
                    booking.value = this.currentItinerary.totalPrice;
                    booking.lastUpdated = new Date().toISOString();
                }
            } else {
                const newBooking = {
                    id: `BK${Math.floor(Math.random() * 900) + 107}`, client: this.currentItinerary.clientName,
                    destination: this.currentItinerary.title.replace(' Package', '').replace('Custom Trip to ',''), status: 'Quoted',
                    value: this.currentItinerary.totalPrice, invoice: null,
                    assignedTo: mockData.user.name,
                    travelDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    travelers: 2,
                    lastUpdated: new Date().toISOString()
                };
                mockData.bookings.unshift(newBooking);
            }
            this.currentItinerary = null;
            this.navigate('bookings');
        },
        generateInvoice(bookingId) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            if (booking && !booking.invoice) {
                booking.invoice = { id: `INV-00${mockData.bookings.filter(b => b.invoice).length + 1}`, status: 'Due', amount: booking.value, paid: 0 };
                booking.lastUpdated = new Date().toISOString();
                this.showToast('Invoice generated!', 'success');
                this.render();
            }
        },
        showLogPaymentModal(bookingId) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            if (!booking || !booking.invoice) return;
            const remaining = booking.invoice.amount - booking.invoice.paid;
            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Log Payment for ${booking.invoice.id}</h3>
                    <p class="text-sm">Amount Due: <span class="font-bold">₹${remaining.toLocaleString('en-IN')}</span></p>
                    <input type="number" id="payment-amount" placeholder="Enter amount" class="mt-2" value="${remaining}">
                    <div class="mt-4 flex justify-end space-x-2">
                        <button data-action="closeModal" class="btn-secondary-outline">Cancel</button>
                        <button data-action="submitPayment" data-booking-id="${bookingId}" class="btn-success">Submit Payment</button>
                    </div>
                </div>`;
            this.openModal(modalContent);
        },
        logPayment(bookingId) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            const amountInput = document.getElementById('payment-amount');
            if (!amountInput) return;
            const amount = parseFloat(amountInput.value);
            if (booking && booking.invoice && amount > 0) {
                booking.invoice.paid += amount;
                booking.invoice.status = booking.invoice.paid >= booking.invoice.amount ? 'Paid' : 'Due';
                booking.lastUpdated = new Date().toISOString();
                this.showToast('Payment logged!', 'success');
                this.closeModal();
                this.render();
            } else if (!amount || amount <= 0) {
                this.showToast('Please enter a valid amount.', 'error');
            } else {
                this.showToast('Error logging payment.', 'error');
            }
        },
        submitReview(supplierId) {
            const commentInput = document.getElementById('review-comment');
            if (!commentInput) return;
            const comment = commentInput.value;
            if (comment) {
                const supplier = mockData.suppliers.find(s => s.id === supplierId);
                if(supplier) {
                    supplier.peerReviews.unshift({
                        by: mockData.user.agency,
                        rating: 5, // Mock rating
                        comment: comment
                    });
                    supplier.reviews += 1;
                    // Mock score update
                    supplier.trustScore = Math.min(100, supplier.trustScore + 1);
                }
                commentInput.value = '';
                this.showToast("Thank you for your review!", 'success');
                this.render();
            } else {
                this.showToast("Please write a comment.", "error");
            }
        },
        generateChecklist(bookingId) {
            const tripData = mockData.liveTripData[bookingId];
            if(tripData) {
                tripData.checklist = [
                    { category: 'Documents', items: [{ text: 'Confirm flight tickets', done: true }, { text: 'Verify hotel confirmations', done: false }] },
                    { category: 'Packing', items: [{ text: 'Pack warm clothing', done: false }] },
                    { category: 'Final Checks', items: [{ text: 'Share itinerary with client', done: true }, { text: 'Confirm transport details', done: false }] }
                ];
                this.showToast("✨ AI Checklist Generated!", 'success');
                this.render();
            } else {
                this.showToast("Could not generate checklist for this trip.", "error");
            }
        },
        showHotelOptions(dayIndex) {
            const currentHotelId = this.currentItinerary?.dayWisePlan?.[dayIndex]?.hotelId;
            const destination = this.currentItinerary?.destination || "All";
            const relevantHotels = destination === "All" 
                ? mockData.hotels 
                : mockData.hotels.filter(h => h.destination === destination);

            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Change Hotel for Day ${dayIndex+1}</h3>
                    <div class="space-y-3 max-h-[50vh] overflow-y-auto -mx-4 px-4">
                        ${relevantHotels.map(h => `
                            <div class="border rounded-lg p-3 flex items-center ${currentHotelId === h.id ? 'bg-brand-bg border-brand-text' : 'border-input-border'}">
                                <img src="${h.img}" class="w-12 h-12 rounded-md object-cover mr-3" alt="${h.name}" onerror="this.src='https://placehold.co/80x80/f1f5f9/475569?text=?'">
                                <div class="flex-1">
                                    <p class="font-semibold text-sm">${h.name}</p>
                                    <p class="text-xs text-muted">${h.rating} ★ | ₹${h.price.toLocaleString('en-IN')}</p>
                                </div>
                                <button data-action="selectHotel" data-day-index="${dayIndex}" data-hotel-id="${h.id}" class="text-sm !py-2 !px-4 ${currentHotelId === h.id ? 'btn-secondary' : 'btn-primary'}" ${currentHotelId === h.id ? 'disabled' : ''}>
                                    ${currentHotelId === h.id ? 'Selected' : 'Select'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="closeModal" class="btn-secondary-outline">Close</button>
                    </div>
                </div>`;
            this.openModal(modalContent);
        },
        selectHotel(dayIndex, hotelId) {
            if (!this.currentItinerary || !this.currentItinerary.dayWisePlan[dayIndex]) return;
            // ... (price adjustment logic remains the same)
            const oldHotelId = this.currentItinerary.dayWisePlan[dayIndex].hotelId;
            const oldHotel = mockData.hotels.find(h => h.id === oldHotelId);
            const newHotel = mockData.hotels.find(h => h.id === hotelId);
            const priceDifference = (newHotel ? newHotel.price : 0) - (oldHotel ? oldHotel.price : 0);
            const costDifference = priceDifference * 0.8;
            this.currentItinerary.dayWisePlan[dayIndex].hotelId = hotelId;
            this.currentItinerary.price += priceDifference;
            this.currentItinerary.totalPrice += priceDifference;
            this.currentItinerary.baseCost += costDifference;
            this.updateItineraryProfit();
            this.showToast('Hotel updated!', 'success');
            this.closeModal();
            this.render();
        },
        updatePricingOptimizer(value) {
            const analysis = mockData.analyticsData.pricingAnalysis['PKG_MANALI_01'];
            const price = parseInt(value, 10);
            const commission = price > analysis.baseCost ? ((price - analysis.baseCost) / price * 100).toFixed(1) : 0;
            const priceEl = document.getElementById('pricing-optimizer-price');
            const commissionEl = document.getElementById('pricing-optimizer-commission');
            if (priceEl) priceEl.textContent = `₹${price.toLocaleString('en-IN')}`;
            if (commissionEl) commissionEl.textContent = `${commission}% Commission`;
        },
        // ========================================================================
        // ========================= NEW BOOKING & ASSIGNMENT FLOW ================
        // ========================================================================
        showClientSelectionForItinerary(packageId) {
            const inquiryBookings = mockData.bookings.filter(b => b.status === 'Inquiry' || b.status === 'Quoted');
            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Who is this itinerary for?</h3>
                    <div class="space-y-2 max-h-[50vh] overflow-y-auto -mx-4 px-4">
                        <button data-action="selectClientForItinerary" data-package-id="${packageId || ''}" data-booking-id="new" class="w-full text-left p-3 bg-brand-bg text-brand-text rounded-lg font-medium hover:bg-brand-bg">
                            <i class="ph-user-plus mr-2"></i> A New Client
                        </button>
                        ${inquiryBookings.map(b => `
                            <button data-action="selectClientForItinerary" data-package-id="${packageId || ''}" data-booking-id="${b.id}" class="w-full text-left p-3 bg-panel-2 rounded-lg font-medium hover:bg-bg">
                                ${b.client} - ${b.destination} <span class="text-xs text-muted">(${b.status})</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="closeModal" class="btn-secondary-outline">Cancel</button>
                    </div>
                </div>
            `;
            this.openModal(modalContent);
        },
        selectClientForItinerary(packageId, bookingId) {
            this.closeModal();
            if (packageId) {
                this.navigate('itinerary_builder', { packageId: packageId, bookingId: bookingId });
            } else {
                this.createCustomItinerary(bookingId);
            }
        },
        showNewBookingModal() {
            this.newBookingState = { step: 1, data: {} };
            this.renderNewBookingStep();
        },
        renderNewBookingStep() {
            let content = '';
            switch(this.newBookingState.step) {
                case 1: // Client Details
                    content = `
                        <h3 class="text-lg font-bold mb-4">Step 1: Client Details</h3>
                        <div class="space-y-3">
                            <div><label class="text-sm font-medium text-muted">Client Name</label><input type="text" id="nb-client-name" class="mt-1" placeholder="e.g., Anjali Sharma" value="${this.newBookingState.data.clientName || ''}"></div>
                            <div><label class="text-sm font-medium text-muted">Contact Number</label><input type="tel" id="nb-client-phone" class="mt-1" placeholder="e.g., 9876543210" value="${this.newBookingState.data.clientPhone || ''}"></div>
                        </div>
                    `;
                    break;
                case 2: // Trip Details
                    content = `
                        <h3 class="text-lg font-bold mb-4">Step 2: Trip Details</h3>
                        <div class="space-y-3">
                            <div><label class="text-sm font-medium text-muted">Destination</label><input type="text" id="nb-destination" class="mt-1" placeholder="e.g., Kerala" value="${this.newBookingState.data.destination || ''}"></div>
                            <div><label class="text-sm font-medium text-muted">Travel Date</label><input type="date" id="nb-travel-date" class="mt-1" value="${this.newBookingState.data.travelDate || ''}"></div>
                            <div><label class="text-sm font-medium text-muted">Number of Travelers</label><input type="number" id="nb-travelers" class="mt-1" placeholder="e.g., 4" value="${this.newBookingState.data.travelers || ''}"></div>
                        </div>
                    `;
                    break;
                case 3: // Summary
                    const formattedDate = this.newBookingState.data.travelDate
                        ? new Date(this.newBookingState.data.travelDate).toLocaleDateString('en-IN', {day:'numeric', month:'long', year:'numeric'})
                        : 'Not set';
                    content = `
                        <h3 class="text-lg font-bold mb-4">Step 3: Review & Confirm</h3>
                        <div class="space-y-2 text-sm border p-3 rounded-lg bg-panel-2">
                            <p><strong class="text-muted">Client:</strong> ${this.newBookingState.data.clientName || 'N/A'}</p>
                            <p><strong class="text-muted">Destination:</strong> ${this.newBookingState.data.destination || 'N/A'}</Nothing>
                            <p><strong class="text-muted">Date:</strong> ${formattedDate}</p>
                            <p><strong class="text-muted">Travelers:</strong> ${this.newBookingState.data.travelers || 'N/A'}</p>
                        </div>
                        <p class="text-xs text-muted mt-2">This will create a new entry in your "Inquiry" pipeline.</p>
                    `;
                    break;
            }
            const modalHTML = `
                <div class="modal-content">
                    ${content}
                    <div class="mt-6 flex justify-between">
                        <button data-action="prevBookingStep" class="btn-secondary-outline ${this.newBookingState.step === 1 ? 'invisible' : ''}">Back</button>
                        ${this.newBookingState.step < 3
                            ? `<button data-action="nextBookingStep" class="btn-primary">Next</button>`
                            : `<button data-action="createBooking" class="btn-success">Create Inquiry</button>`
                        }
                    </div>
                </div>
            `;
            this.openModal(modalHTML);
            // Restore input values after modal is rendered
            if (this.newBookingState.step === 1) {
                const clientNameInput = document.getElementById('nb-client-name');
                const clientPhoneInput = document.getElementById('nb-client-phone');
                if (clientNameInput) clientNameInput.value = this.newBookingState.data.clientName || '';
                if (clientPhoneInput) clientPhoneInput.value = this.newBookingState.data.clientPhone || '';
            } else if (this.newBookingState.step === 2) {
                const destinationInput = document.getElementById('nb-destination');
                const travelDateInput = document.getElementById('nb-travel-date');
                const travelersInput = document.getElementById('nb-travelers');
                if(destinationInput) destinationInput.value = this.newBookingState.data.destination || '';
                if(travelDateInput) travelDateInput.value = this.newBookingState.data.travelDate || '';
                if(travelersInput) travelersInput.value = this.newBookingState.data.travelers || '';
            }
        },
        handleNewBookingStep(direction) {
            // Save data from current step
            if (this.newBookingState.step === 1) {
                const clientNameInput = document.getElementById('nb-client-name');
                const clientPhoneInput = document.getElementById('nb-client-phone');
                if(clientNameInput) this.newBookingState.data.clientName = clientNameInput.value;
                if(clientPhoneInput) this.newBookingState.data.clientPhone = clientPhoneInput.value;
            } else if (this.newBookingState.step === 2) {
                const destinationInput = document.getElementById('nb-destination');
                const travelDateInput = document.getElementById('nb-travel-date');
                const travelersInput = document.getElementById('nb-travelers');
                if(destinationInput) this.newBookingState.data.destination = destinationInput.value;
                if(travelDateInput) this.newBookingState.data.travelDate = travelDateInput.value;
                if(travelersInput) this.newBookingState.data.travelers = travelersInput.value;
            }
            // Basic validation before proceeding
            if (direction === 'next') {
                if (this.newBookingState.step === 1 && !this.newBookingState.data.clientName) {
                    this.showToast("Please enter client name.", "error"); return;
                }
                if (this.newBookingState.step === 2 && (!this.newBookingState.data.destination || !this.newBookingState.data.travelDate)) {
                    this.showToast("Please enter destination and travel date.", "error"); return;
                }
                this.newBookingState.step++;
            }
            if (direction === 'prev') this.newBookingState.step--;
            this.renderNewBookingStep();
        },
        createBooking() {
            const data = this.newBookingState.data;
            if(!data.clientName || !data.destination || !data.travelDate) {
                this.showToast("Please fill all details.", "error");
                return;
            }
            const newBooking = {
                id: `BK${Math.floor(Math.random() * 900) + 112}`,
                client: data.clientName,
                destination: data.destination,
                status: 'Inquiry',
                value: 0,
                invoice: null,
                travelDate: data.travelDate,
                assignedTo: null,
                travelers: data.travelers || 1,
                lastUpdated: new Date().toISOString()
            };
            mockData.bookings.unshift(newBooking);
            if (!mockData.clients.some(c => c.name === data.clientName)) {
                mockData.clients.push({ id: `C_${Math.random().toString(36).substr(2, 5)}`, name: data.clientName, totalBookings: 1, totalSpend: 0, lastTrip: data.destination, communication: [] });
            }
            this.closeModal();
            this.showToast('New inquiry created successfully!', 'success');
            this.navigate('bookings');
        },
        showAssignModal(bookingId) {
            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Assign to Team</h3>
                    <div class="space-y-2 max-h-[50vh] overflow-y-auto -mx-4 px-4">
                        ${mockData.teams.map(team => `
                            <button data-action="assignToTeam" data-booking-id="${bookingId}" data-team-name="${team}" class="w-full text-left p-3 bg-panel-2 rounded-lg font-medium hover:bg-bg">${team}</button>
                        `).join('')}
                        <button data-action="assignToTeam" data-booking-id="${bookingId}" data-team-name="" class="w-full text-left p-3 text-muted rounded-lg font-medium hover:bg-bg">Unassign</button>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="closeModal" class="btn-secondary-outline">Cancel</button>
                    </div>
                </div>`;
            this.openModal(modalContent);
        },
        assignToTeam(bookingId, teamName) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            if (booking) {
                booking.assignedTo = teamName || null; // Set to null if teamName is empty (for Unassign)
                booking.lastUpdated = new Date().toISOString();
                this.closeModal();
                this.render();
                this.showToast(teamName ? `Assigned to ${teamName}` : 'Unassigned', 'info');
            }
        },
        showEditBookingModal(bookingId) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            if(!booking) return;
            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Edit Trip Details</h3>
                    <div class="space-y-3">
                        <div><label class="text-sm font-medium text-muted">Destination</label><input type="text" id="edit-destination" class="mt-1" value="${booking.destination}"></div>
                        <div><label class="text-sm font-medium text-muted">Travel Date</label><input type="date" id="edit-travel-date" class="mt-1" value="${booking.travelDate || ''}"></div>
                        <div><label class="text-sm font-medium text-muted">Number of Travelers</label><input type="number" id="edit-travelers" class="mt-1" value="${booking.travelers || ''}"></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button data-action="closeModal" class="btn-secondary-outline">Cancel</button>
                        <button data-action="updateBookingDetails" data-booking-id="${bookingId}" class="btn-primary">Save Changes</button>
                    </div>
                </div>
            `;
            this.openModal(modalContent);
        },
        updateBookingDetails(bookingId) {
            const booking = mockData.bookings.find(b => b.id === bookingId);
            const destinationInput = document.getElementById('edit-destination');
            const travelDateInput = document.getElementById('edit-travel-date');
            const travelersInput = document.getElementById('edit-travelers');
            if(booking && destinationInput && travelDateInput && travelersInput) {
                booking.destination = destinationInput.value;
                booking.travelDate = travelDateInput.value;
                booking.travelers = travelersInput.value;
                booking.lastUpdated = new Date().toISOString();
                this.closeModal();
                this.render();
                this.showToast("Booking details updated!", 'success');
            } else {
                this.showToast("Error updating details.", "error");
            }
        },
        createCustomItinerary(bookingId) {
            let clientName = "New Client";
            let destination = "New Destination";
            if (bookingId && bookingId !== 'new') {
                const booking = mockData.bookings.find(b => b.id === bookingId);
                if (booking) {
                    clientName = booking.client;
                    destination = booking.destination;
                }
            }
            this.currentItinerary = {
                title: `Custom Trip to ${destination}`,
                clientName: clientName,
                bookingId: (bookingId === 'new') ? null : bookingId,
                dayWisePlan: [
                    { day: 1, title: "Arrival & Check-in", activities: [], hotelId: null, flightId: null, items: [] }
                ],
                price: 0, baseCost: 0, addons: [], profit: 0, margin: 0,
                totalPrice: 0,
                components: [] // Start with no components
            };
            this.navigate('custom_itinerary_builder');
        },
        addDayToCustomItinerary() {
            if (!this.currentItinerary) return;
            const newDay = this.currentItinerary.dayWisePlan.length + 1;
            this.currentItinerary.dayWisePlan.push({
                day: newDay,
                title: `Day ${newDay} Activities`,
                activities: [],
                hotelId: null
            });
            this.render(); // Re-render to show the new day
            // Optional: Scroll to the new day
            setTimeout(() => {
                const container = document.getElementById('custom-plan-container');
                if(container) container.lastElementChild?.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        },
        showBookingFiltersModal() {
            const modalContent = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Filter & Sort Bookings</h3>
                    <div class="mb-4">
                        <h4 class="font-semibold text-sm text-muted mb-2">Filter by Assignment</h4>
                        <div class="flex flex-wrap gap-2 text-sm">
                            <button class="filter-btn-assignedTo !py-2 !px-3 btn-secondary-outline" data-value="all">All</button>
                            <button class="filter-btn-assignedTo !py-2 !px-3 btn-secondary-outline" data-value="me">Assigned to Me / My Teams</button>
                            <button class="filter-btn-assignedTo !py-2 !px-3 btn-secondary-outline" data-value="unassigned">Unassigned</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold text-sm text-muted mb-2">Other Filters</h4>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="filter-actionRequired" class="h-4 w-4 rounded border-gray-300 text-brand focus:ring-brand-bg" ${this.bookingFilters.actionRequired ? 'checked' : ''}>
                                <label for="filter-actionRequired" class="ml-2 text-sm">Action Required (Overdue, Unassigned, Urgent)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="filter-highValue" class="h-4 w-4 rounded border-gray-300 text-brand focus:ring-brand-bg" ${this.bookingFilters.highValue ? 'checked' : ''}>
                                <label for="filter-highValue" class="ml-2 text-sm">High Value (> ₹2L)</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h4 class="font-semibold text-sm text-muted mb-2">Sort by</h4>
                        <select id="sort-bookings" class="w-full">
                            <option value="travelDate" ${this.bookingSort === 'travelDate' ? 'selected' : ''}>Travel Date (Soonest First)</option>
                            <option value="lastUpdated" ${this.bookingSort === 'lastUpdated' ? 'selected' : ''}>Last Updated (Newest First)</option>
                            <option value="value" ${this.bookingSort === 'value' ? 'selected' : ''}>Value (High to Low)</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button data-action="closeModal" class="btn-secondary-outline">Cancel</button>
                        <button data-action="applyBookingFilters" class="btn-primary">Apply Filters</button>
                    </div>
                </div>
            `;
            this.openModal(modalContent);
            // Add active styles and click handler for filter buttons
            document.querySelectorAll('.filter-btn-assignedTo').forEach(btn => {
                if(btn.dataset.value === this.bookingFilters.assignedTo) {
                    btn.classList.add('bg-brand', 'text-white', '!border-brand');
                }
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn-assignedTo').forEach(b => b.classList.remove('bg-brand', 'text-white', '!border-brand'));
                    btn.classList.add('bg-brand', 'text-white', '!border-brand');
                });
            });
        },
        applyBookingFilters() {
            const selectedAssignmentFilter = document.querySelector('.filter-btn-assignedTo.bg-brand');
            this.bookingFilters.assignedTo = selectedAssignmentFilter ? selectedAssignmentFilter.dataset.value : 'all';
            this.bookingFilters.actionRequired = document.getElementById('filter-actionRequired').checked;
            this.bookingFilters.highValue = document.getElementById('filter-highValue').checked;
            this.bookingSort = document.getElementById('sort-bookings').value;
            this.closeModal();
            this.render(); // Re-render the bookings view with applied filters/sort
            this.showToast("Filters applied!", "info");
        },
        showSearchFiltersModal() {
            // ... (this logic remains the same)
        },
        applySearchFilters() {
            // ... (this logic remains the same)
        },
        showLeaderboardModal() {
            // ... (this logic remains the same)
        },
        // ========================================================================
        // ========================= GEMINI API FEATURES =========================
        // ========================================================================
        async callGeminiAPI(systemPrompt, userPrompt, useGrounding = false, isJson = false, retries = 3, delay = 1000) {
            // ... (this logic remains the same)
        },
        async optimizeItinerary() {
            // ... (this logic remains the same)
        },
        async draftCrisisUpdate() {
            // ... (this logic remains the same)
        },
        async askLocalExpert() {
            // ... (this logic remains the same)
        },
        showAddStaffModal() {
            // ... (this logic remains the same)
        },
        saveNewStaff() {
            // ... (this logic remains the same)
        },
        // ========================================================================
        // ========================= VIEW RENDERERS =============================
        // ========================================================================
        
        // NEW: Helper function to render a single card (to avoid code duplication)
        _renderItemCard(item, cardType = 'default') {
            if (!item || !item.type) {
                console.warn("Attempted to render invalid item:", item);
                return ''; // Don't render if item is invalid
            }
            const itemType = item.type.toLowerCase();
            const isSaved = this.savedItems[itemType + 's']?.has(item.id);
            const isCompared = this.compareItems.some(c => c.id === item.id);
            const isQuickAdded = this.quickItinerary.some(i => i.id === item.id);

            let detailsHTML = '';
            let priceHTML = '';
            let navigationTarget = `data-action="navigate" data-view="${itemType}_details" data-${itemType}-id="${item.id}"`;
            let cardActions = `
                <button data-action="toggleSaveItem" data-id="${item.id}" data-type="${item.type}" class="card-action-btn save ${isSaved ? 'active' : ''}" title="Save Item">
                    <i class="ph-bookmark-simple text-lg"></i>
                </button>
                <button data-action="toggleCompareItem" data-id="${item.id}" data-type="${item.type}" class="card-action-btn compare ${isCompared ? 'active' : ''}" title="Compare Item">
                    <i class="ph-arrows-left-right text-lg"></i>
                </button>
                <button data-action="toggleQuickItinItem" data-id="${item.id}" data-type="${item.type}" class="card-action-btn quick-add ${isQuickAdded ? 'active' : ''}" title="Add to Quick Itinerary">
                    <i class="ph-${isQuickAdded ? 'check' : 'plus'} text-lg"></i>
                </button>
            `;

            switch(item.type) {
                case 'Package':
                    navigationTarget = `data-action="buildItinerary" data-package-id="${item.id}"`; // Packages go to itinerary builder
                    detailsHTML = `
                        <p class="font-semibold text-sm">${item.title}</p>
                        <p class="text-xs text-muted">${item.duration} Days | ${item.inclusions.slice(0, 2).join(', ')}...</p>
                        <p class="text-xs text-muted">${item.rating} ★ Rating</p>
                    `;
                    priceHTML = `<p class="font-bold text-lg text-ok">₹${item.price.toLocaleString('en-IN')}</p>`;
                    break;
                case 'Hotel':
                    navigationTarget = `data-action="navigate" data-view="hotel_details" data-hotel-id="${item.id}"`; // Mock navigation
                    detailsHTML = `
                        <p class="font-semibold text-sm">${item.name}</p>
                        <p class="text-xs text-muted">${item.destination} | ${item.amenities.slice(0, 2).join(', ')}...</p>
                        <p class="text-xs text-muted">${item.rating} ★ Rating</p>
                    `;
                    priceHTML = `<p class="font-bold text-lg text-ok">₹${item.price.toLocaleString('en-IN')} <span class="text-sm font-normal text-muted">/ night</span></p>`;
                    break;
                case 'Flight':
                    navigationTarget = `data-action="navigate" data-view="flight_details" data-flight-id="${item.id}"`; // Mock navigation
                    detailsHTML = `
                        <div class="flex items-center mb-1">
                            <img src="${item.img}" class="w-5 h-5 rounded-full object-contain mr-2" alt="${item.airline}" onerror="this.style.display='none'">
                            <p class="font-semibold text-sm">${item.airline} <span class="font-normal text-muted">${item.flightNo}</span></p>
                        </div>
                        <p class="text-xs text-muted">${item.from} → ${item.to} (${item.duration})</p>
                        <p class="text-xs text-muted">${item.stops === 0 ? 'Non-stop' : `${item.stops} Stop(s)`}</p>
                    `;
                    priceHTML = `<p class="font-bold text-lg text-ok">₹${item.price.toLocaleString('en-IN')}</p>`;
                    break;
                case 'Supplier':
                    navigationTarget = `data-action="navigate" data-view="supplier_details" data-supplier-id="${item.id}"`;
                    cardActions = `
                        <button data-action="toggleSaveItem" data-id="${item.id}" data-type="${item.type}" class="card-action-btn save static ${isSaved ? 'active' : ''}" title="Save Supplier">
                            <i class="ph-bookmark-simple text-lg"></i>
                        </button>
                    `;
                    detailsHTML = `
                        <p class="font-semibold text-sm">${item.name} ${item.verified ? '<i class="ph-seal-check-fill text-info inline-block ml-1"></i>' : ''}</p>
                        <p class="text-xs text-muted">${item.service}</p>
                        <p class="text-xs text-muted">${item.rating} ★ (${item.reviews} reviews)</p>
                    `;
                    priceHTML = `<p class="font-bold text-lg text-brand">${item.trustScore} <span class="text-sm font-normal text-muted">/ 100</span></p>`;
                    break;
            }

            // Card type 'snippet' is for the live search dropdown
            if (cardType === 'snippet') {
                return `
                    <div ${navigationTarget} class="flex items-center p-3 hover:bg-panel-2 rounded-lg cursor-pointer">
                        <img src="${item.img || 'https://placehold.co/40x40/f1f5f9/475569?text=?'}" class="w-10 h-10 rounded-md object-cover mr-3 flex-shrink-0" alt="${item.title || item.name}" onerror="this.src='https://placehold.co/40x40/f1f5f9/475569?text=?'">
                        <div class="flex-1 min-w-0">
                            ${detailsHTML.replace('font-semibold text-sm', 'font-semibold text-sm truncate')}
                        </div>
                        <div class="text-right ml-2 flex-shrink-0">
                            ${priceHTML.replace('text-lg', 'text-sm')}
                        </div>
                    </div>
                `;
            }

            // Default card
            return `
                <div class="card p-0 flex flex-col relative">
                    <div class="card-actions">
                        ${cardActions}
                    </div>
                    <div ${navigationTarget} class="cursor-pointer">
                        <img src="${item.img}" class="w-full h-32 object-cover" alt="${item.title || item.name}" onerror="this.src='https://placehold.co/600x400/f1f5f9/475569?text=Image+Not+Found'">
                        <div class="p-4 flex-1">
                            ${detailsHTML}
                        </div>
                    </div>
                    <div class="p-4 border-t border-panel-2 mt-auto">
                        <div class="flex justify-between items-center">
                            <div>${priceHTML}</div>
                            ${item.type === 'Package' ? `<button ${navigationTarget} class="btn-primary !text-sm !py-2 !px-4">View Package</button>` : ''}
                            ${item.type === 'Hotel' ? `<button ${navigationTarget} class="btn-secondary-outline !text-sm !py-2 !px-4">View Hotel</button>` : ''}
                            ${item.type === 'Flight' ? `<button ${navigationTarget} class="btn-secondary-outline !text-sm !py-2 !px-4">View Flight</button>` : ''}
                            ${item.type === 'Supplier' ? `<button ${navigationTarget} class="btn-secondary-outline !text-sm !py-2 !px-4">View Supplier</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        },

        render_dashboard() {
            const { user } = mockData;
            const progress = (user.stats.revenue / user.stats.monthlyGoal) * 100;
            const today = new Date();
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // --- Define Action Items ---
            const overduePayments = mockData.bookings.filter(b => b.invoice?.status === 'Overdue');
            const unassignedInquiries = mockData.bookings.filter(b => b.status === 'Inquiry' && !b.assignedTo);
            const urgentDepartures = mockData.upcomingDepartures.filter(d => {
                try {
                    const depDate = new Date(d.departureDate);
                    return !isNaN(depDate) && depDate >= today && depDate <= sevenDaysFromNow;
                } catch (e) { return false; }
            });
            const allActionItems = [
                ...overduePayments.map(b => ({ type: 'Overdue Payment', text: `₹${(b.invoice.amount - b.invoice.paid).toLocaleString('en-IN')} overdue for ${b.client}`, bookingId: b.id, icon: 'ph-warning-circle text-danger' })),
                ...unassignedInquiries.map(b => ({ type: 'Unassigned Inquiry', text: `${b.destination} inquiry from ${b.client} needs assignment`, bookingId: b.id, icon: 'ph-question text-info' })),
                ...urgentDepartures.map(d => ({ type: 'Urgent Departure', text: `${d.client} departing for ${d.destination} soon`, bookingId: d.bookingId, icon: 'ph-airplane-takeoff text-warn' })),
            ].sort((a, b) => {
                const typeOrder = {'Overdue Payment': 1, 'Unassigned Inquiry': 2, 'Urgent Departure': 3};
                return (typeOrder[a.type] || 4) - (typeOrder[b.type] || 4);
            }).slice(0, 5);
            return `
                <!-- NEW: Global Search on Dashboard -->
                <div class="card p-4 mb-4">
                    <h2 class="text-lg font-semibold mb-3 text-brand">✨ Welcome, ${user.name.split(' ')[0]}! What are you looking for?</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="dashboard-search-input" placeholder="Search Packages, Hotels, Clients, Bookings...">
                        <button data-action="globalSearch" class="btn-primary !p-3 h-auto" style="border-radius: var(--radius-md);"><i class="ph-magnifying-glass text-2xl"></i></button>
                    </div>
                </div>

                <!-- Responsive Grid Layout -->
                <div class="lg:grid lg:grid-cols-3 lg:gap-4 space-y-4 lg:space-y-0">
                    <!-- Left Column (Span 2) -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="card p-4 lg:p-5">
                            <h2 class="text-lg font-semibold mb-3">Your Performance</h2>
                            <div class="mt-2">
                                <p class="font-bold text-3xl text-ok">₹${user.stats.revenue.toLocaleString('en-IN')}</p>
                                <div class="w-full bg-panel-2 rounded-full h-2.5 mt-2 overflow-hidden">
                                    <div class="bg-ok h-2.5 rounded-full" style="width: ${progress}%;"></div>
                                </div>
                                <p class="text-xs mt-1 text-right text-muted">${Math.round(progress)}% of your ₹${user.stats.monthlyGoal.toLocaleString('en-IN')} goal</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            ${mockData.kpis.map(kpi => `
                                <div class="card p-3 lg:p-4">
                                    <p class="text-xs text-muted">${kpi.label}</p>
                                    <p class="text-xl lg:text-2xl font-bold mt-1">${kpi.value}</p>
                                    <p class="text-xs font-bold ${kpi.change.startsWith('+') ? 'text-ok' : 'text-danger'}">${kpi.change}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div id="ai-opportunities">
                            <h2 class="text-lg font-semibold mb-3 text-brand">💡 AI-Powered Opportunities</h2>
                            <div class="space-y-3">
                                ${mockData.smartFeed.map(item => {
                                    const colors = { opportunity: 'border-brand', engagement: 'border-ok', alert: 'border-warn' };
                                    const textColors = { opportunity: 'text-brand', engagement: 'text-ok', alert: 'text-warn' };
                                    return `
                                    <div class="card p-4 border-l-4 ${colors[item.type] || 'border-muted'}">
                                        <div class="flex items-start">
                                            <i class="ph ${item.icon} text-2xl ${textColors[item.type] || 'text-muted'} mr-3 mt-1"></i>
                                            <div>
                                                <h3 class="font-bold text-sm">${item.title}</h3>
                                                <p class="text-sm mt-1 text-muted">${item.text}</p>
                                                <button data-action="${item.action}" data-view="${item.view}" ${item.clientId ? `data-client-id="${item.clientId}"` : ''} ${item.supplierId ? `data-supplier-id="${item.supplierId}"` : ''} ${item.query ? `data-query="${item.query}"` : ''} class="mt-3 text-sm font-bold btn-link">
                                                    ${item.actionText} <i class="ph-arrow-right inline-block"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    `
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <!-- Right Column (Span 1) -->
                    <div class="lg:col-span-1 space-y-4">
                        <div class="card p-4 lg:p-5">
                            <h2 class="text-lg font-semibold mb-3">My Action Items</h2>
                            <div class="space-y-3">
                                ${allActionItems.length > 0 ? allActionItems.map(item => `
                                    <div data-action="navigate" data-view="booking_details" data-booking-id="${item.bookingId}" class="text-sm border-b border-panel-2 pb-2 last:border-b-0 flex items-start cursor-pointer hover:bg-panel-2 -mx-2 px-2 py-1 rounded">
                                        <i class="ph ${item.icon} text-xl mr-2 mt-0.5 flex-shrink-0"></i>
                                        <div>
                                            <p>${item.text}</p>
                                            <p class="text-xs opacity-70 text-muted">${item.type}</p>
                                        </div>
                                    </div>
                                `).join('') : `<p class="text-sm text-center py-4 text-muted">No urgent actions found.</p>`}
                            </div>
                        </div>
                        ${(user.role === 'Admin' || user.role === 'Manager') ? `
                        <div class="card p-4 lg:p-5">
                            <h2 class="text-lg font-semibold mb-3">Live Team Activity</h2>
                            <div class="space-y-2">
                            ${mockData.teamActivity.slice(0, 3).map(activity => `
                                <div class="text-sm flex items-start">
                                    <i class="ph-info text-info mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span class="text-muted">${activity.text}</span>
                                </div>
                            `).join('')}
                            ${mockData.teamActivity.length > 3 ? '<button data-action="navigate" data-view="team_hub" data-tab="Activity" class="text-sm btn-link w-full text-left mt-2">View More</button>' : ''}
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        },
        render_bookings() {
            const statuses = ["Inquiry", "Quoted", "Confirmed", "In-Progress", "Completed"];
            const today = new Date();
            
            // --- Filtering Logic ---
            let filteredBookings = [...mockData.bookings];
            if (this.bookingFilters.assignedTo === 'me') {
                filteredBookings = filteredBookings.filter(b => b.assignedTo === mockData.user.name || mockData.teams.includes(b.assignedTo));
            } else if (this.bookingFilters.assignedTo === 'unassigned') {
                filteredBookings = filteredBookings.filter(b => !b.assignedTo);
            }
            if (this.bookingFilters.actionRequired) {
                filteredBookings = filteredBookings.filter(b => {
                    try {
                        const travelDate = new Date(b.travelDate);
                        const diffDays = !isNaN(travelDate) ? (travelDate - today) / (1000 * 60 * 60 * 24) : Infinity;
                        return b.invoice?.status === 'Overdue' || (!b.assignedTo && b.status === 'Inquiry') || (diffDays >= 0 && diffDays <= 7);
                    } catch (e) { return false; }
                });
            }
            if (this.bookingFilters.highValue) {
                filteredBookings = filteredBookings.filter(b => b.value > 200000);
            }
            
            // --- Sorting Logic ---
            if (this.bookingSort === 'travelDate') {
                filteredBookings.sort((a, b) => (new Date(a.travelDate) || 0) - (new Date(b.travelDate) || 0));
            } else if (this.bookingSort === 'lastUpdated') {
                filteredBookings.sort((a, b) => (new Date(b.lastUpdated) || 0) - (new Date(a.lastUpdated) || 0));
            } else if (this.bookingSort === 'value') {
                filteredBookings.sort((a, b) => b.value - a.value);
            }

            // --- Mobile View HTML ---
            const mobileViewHTML = () => {
                const mobileFilteredBookings = filteredBookings.filter(b => b.status === this.bookingStatusTab);
                const pipelineSummary = statuses.map(status => {
                    const count = mockData.bookings.filter(b => b.status === status).length;
                    return { status, count };
                });
                return `
                    <div id="kanban-board-mobile" class="flex flex-col h-full lg:hidden">
                        <div class="booking-tab-container">
                            ${statuses.map(status => `
                                <button data-action="changeBookingStatusTab" data-status="${status}" class="booking-tab ${this.bookingStatusTab === status ? 'active' : ''}">
                                    ${status} <span class="text-xs opacity-70 ml-1">${pipelineSummary.find(p=>p.status===status)?.count || 0}</span>
                                </button>
                            `).join('')}
                            <button data-action="showBookingFilters" class="ml-auto flex-shrink-0 !p-2 !w-9 !h-9 rounded-full relative bg-panel border border-input-border shadow">
                                <i class="ph-funnel text-lg"></i>
                                ${this.bookingFilters.actionRequired || this.bookingFilters.highValue || this.bookingFilters.assignedTo !== 'all' ? '<span class="filter-count !top-0 !right-0">!</span>' : ''}
                            </button>
                        </div>
                        <div class="space-y-3 mt-4 flex-1 overflow-y-auto -mx-1 px-1">
                            ${mobileFilteredBookings.length > 0 ? mobileFilteredBookings.map(booking => this._renderBookingCard(booking, today)).join('') : `<div class="text-center text-sm pt-10 card text-muted">No bookings in this stage.</div>`}
                        </div>
                    </div>
                `;
            };

            // --- Desktop View HTML ---
            const desktopViewHTML = () => {
                return `
                    <div id="kanban-board-desktop" class="hidden lg:flex h-full flex-col">
                        <div class="flex items-center mb-4">
                            <h2 class="text-xl font-semibold">Bookings Pipeline</h2>
                            <button data-action="showBookingFilters" class="ml-auto flex items-center flex-shrink-0 !py-2 !px-3 rounded-full text-sm font-medium btn-secondary-outline relative">
                                <i class="ph-funnel text-lg mr-1"></i> Filter & Sort
                                ${this.bookingFilters.actionRequired || this.bookingFilters.highValue || this.bookingFilters.assignedTo !== 'all' ? '<span class="filter-count">!</span>' : ''}
                            </button>
                        </div>
                        <div class="flex-1 grid grid-cols-5 gap-4 min-h-0">
                            ${statuses.map(status => {
                                const columnBookings = filteredBookings.filter(b => b.status === status);
                                const columnValue = columnBookings.reduce((sum, b) => sum + b.value, 0);
                                return `
                                <div class="flex flex-col bg-bg rounded-lg p-3">
                                    <h3 class="font-semibold mb-1 px-1">${status} <span class="text-sm font-normal opacity-70">(${columnBookings.length})</span></h3>
                                    <p class="text-xs text-muted font-medium mb-3 px-1">₹${columnValue > 99999 ? (columnValue/100000).toFixed(1) + 'L' : (columnValue/1000).toFixed(0) + 'k'}</p>
                                    <div class="space-y-3 overflow-y-auto flex-1 -mx-1 px-1">
                                        ${columnBookings.length > 0 ? columnBookings.map(booking => this._renderBookingCard(booking, today)).join('') : '<p class="text-xs text-center p-2 text-muted">No bookings.</p>'}
                                    </div>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </div>
                `;
            };
            return mobileViewHTML() + desktopViewHTML();
        },
        _renderBookingCard(booking, today) {
            let indicatorHTML = '';
            let travelDate = null;
            try { travelDate = new Date(booking.travelDate); } catch(e){}
            const diffDays = travelDate && !isNaN(travelDate) ? (travelDate - today) / (1000 * 60 * 60 * 24) : Infinity;
            if (booking.invoice?.status === 'Overdue') {
                indicatorHTML = `<span class="absolute top-3 right-3 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-danger" title="Payment Overdue"></span>`;
            } else if (diffDays >= 0 && diffDays <= 7) {
                indicatorHTML = `<span class="absolute top-3 right-3 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-warn" title="Upcoming Travel"></span>`;
            } else if (!booking.assignedTo && booking.status === 'Inquiry') {
                indicatorHTML = `<span class="absolute top-3 right-3 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-info" title="Unassigned"></span>`;
            }
            const getInitials = (name) => name ? name.split(' ').map(n => n[0]).join('') : '?';
            const assignedUser = mockData.staff.find(s => s.name === booking.assignedTo) || (mockData.user.name === booking.assignedTo ? mockData.user : null);
            let assignedToHTML = '';
            if (booking.assignedTo) {
                if (assignedUser) {
                    assignedToHTML = `<div class="w-6 h-6 rounded-full bg-brand-bg text-brand-text text-xs font-bold flex items-center justify-center" title="${assignedUser.name}">${getInitials(assignedUser.name)}</div>`;
                } else {
                    assignedToHTML = `<div class="text-xs font-semibold bg-panel-2 px-2 py-1 rounded-md">${booking.assignedTo}</div>`;
                }
            }
            let paymentProgressHTML = '';
            if(booking.invoice) {
                const progress = booking.invoice.amount > 0 ? (booking.invoice.paid / booking.invoice.amount) * 100 : 0;
                paymentProgressHTML = `
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-muted">Payment</span>
                            <span class="text-muted">₹${booking.invoice.paid.toLocaleString('en-IN')} / ₹${booking.invoice.amount.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="w-full bg-panel-2 rounded-full h-1.5 overflow-hidden">
                            <div class="h-1.5 rounded-full ${progress < 100 ? 'bg-warn' : 'bg-ok'}" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="swipe-container rounded-lg">
                    <div class="swipe-actions">
                        ${booking.invoice && booking.invoice.status !== 'Paid' ? `<div data-action="logPayment" data-booking-id="${booking.id}" class="swipe-action-button bg-ok"><i class="ph-currency-inr text-2xl"></i><span class="text-xs mt-1">Pay</span></div>` : ''}
                        <div data-action="navigate" data-view="client_details" data-client-id="${mockData.clients.find(c => c.name === booking.client)?.id || ''}" class="swipe-action-button bg-info"><i class="ph-phone text-2xl"></i><span class="text-xs mt-1">Call</span></div>
                    </div>
                    <div data-action="navigate" data-view="booking_details" data-booking-id="${booking.id}" class="swipe-content card !p-0 cursor-pointer relative">
                        <div class="p-4">
                            <i class="ph-dots-six-vertical-bold swipe-hint lg:hidden"></i>
                            ${indicatorHTML}
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold pr-4">${booking.client}</p>
                                    <p class="text-sm text-muted">${booking.destination}</p>
                                </div>
                                <p class="text-lg font-bold text-right text-ok">₹${booking.value > 0 ? booking.value.toLocaleString('en-IN') : 'N/A'}</p>
                            </div>
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-panel-2">
                                <div class="flex items-center text-xs space-x-3 text-muted">
                                    ${booking.travelDate ? `<span class="flex items-center"><i class="ph-calendar-blank mr-1"></i> ${new Date(booking.travelDate).toLocaleDateString('en-IN', {day: 'numeric', month: 'short'})}</span>` : ''}
                                    <span class="flex items-center"><i class="ph-users mr-1"></i> ${booking.travelers || '?'}</span>
                                </div>
                                ${assignedToHTML}
                            </div>
                            ${paymentProgressHTML}
                        </div>
                        ${booking.packageId ? `<div class="bg-panel-2 px-4 py-2 border-t border-input-border"><button data-action="navigate" data-view="itinerary_builder" data-package-id="${booking.packageId}" data-booking-id="${booking.id}" class="btn-link text-sm !font-medium">View Itinerary</button></div>` : ''}
                    </div>
                </div>
            `;
        },
        render_search() {
            const { fromInquiry, fromCustomItinerary } = this.navigationContext;
            let title = "Search";
            if (fromInquiry) title = "Find Package for Inquiry";
            if (fromCustomItinerary) title = `Add ${this.searchTab} to Itinerary`;

            return `
                <div class="space-y-4">
                    ${fromInquiry || fromCustomItinerary ? `<h2 class="text-lg font-semibold">${title}</h2>` : ''}
                    
                    <!-- Global AI Search -->
                    <div class="card p-4">
                        <h2 class="text-lg font-semibold mb-3 text-brand">✨ AI Smart Search</h2>
                        <p class="text-sm mb-3 text-muted">Search for anything: "luxury goa hotel with pool", "BK101", "Sharma Family", "Jaipur Cabs"...</p>
                        <div class="flex space-x-2">
                            <input type="text" id="global-search-input" placeholder="Search with AI..." class="!py-3" value="${this.navigationContext.query || ''}">
                            <button id="global-search-btn" data-action="globalSearch" class="btn-primary !p-3 h-auto" style="border-radius: var(--radius-md);"><i class="ph-magnifying-glass text-2xl"></i></button>
                        </div>
                        <!-- Live Search Results Container (for desktop) -->
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>

                    <!-- Recent Searches -->
                    <div class="p-2">
                        <h3 class="text-sm font-semibold text-muted mb-2">Recent Searches</h3>
                        <div class="flex flex-wrap gap-2">
                            ${mockData.recentSearches.map(query => `
                                <button data-action="runRecentSearch" data-query="${query}" class="btn-secondary-outline !text-sm !font-medium !py-1.5 !px-3 search-suggestion-pill">
                                    ${query}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Browse by Category -->
                    <div class="p-2">
                        <h3 class="text-lg font-semibold mb-3">Browse by Category</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            ${mockData.browseCategories.map(cat => `
                                <div data-action="runCategorySearch" data-query="${cat.query}" class="rounded-lg overflow-hidden relative cursor-pointer group shadow-md hover:shadow-lg transition-shadow">
                                    <img src="${cat.img}" class="w-full h-24 object-cover" alt="${cat.name}" onerror="this.src='https://placehold.co/300x200/f1f5f9/475569?text=${cat.name}'">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                    <p class="absolute bottom-2 left-2 text-white font-bold text-sm">${cat.name}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },
        _renderSearchResultsHTML(query, asSnippet = false) {
            const allItems = [
                ...mockData.searchResults,
                ...mockData.hotels,
                ...mockData.flights,
                ...mockData.suppliers
            ];
            const lowerQuery = query.toLowerCase();
            let results = allItems.filter(item => {
                const title = item.title || item.name || '';
                const details = item.details || item.service || '';
                const destination = item.destination || item.from || item.to || '';
                return title.toLowerCase().includes(lowerQuery) ||
                       details.toLowerCase().includes(lowerQuery) ||
                       destination.toLowerCase().includes(lowerQuery) ||
                       item.id.toLowerCase().includes(lowerQuery);
            });

            // Apply Filters
            const { type, priceRange, rating, amenities, stops } = this.searchFilters;
            if (type !== 'all') {
                results = results.filter(item => item.type.toLowerCase() === type);
            }
            if (priceRange) {
                results = results.filter(item => item.price >= priceRange[0] && item.price <= priceRange[1]);
            }
            if (rating > 0) {
                results = results.filter(item => item.rating >= rating);
            }
            if (amenities.length > 0) {
                results = results.filter(item => item.amenities && amenities.every(a => item.amenities.includes(a)));
            }
            if (stops !== null) {
                results = results.filter(item => item.type === 'Flight' && item.stops === stops);
            }
            
            if (results.length === 0) {
                return `<div class="card text-center p-10"><p class="text-muted">No results found for "${query}".</p></div>`;
            }

            if (asSnippet) {
                // Snippet view for live search
                return results.slice(0, 5).map(item => this._renderItemCard(item, 'snippet')).join('');
            }

            // Full card view for results page
            return `<div class="search-results-grid">${results.map(item => this._renderItemCard(item)).join('')}</div>`;
        },
        _renderSearchSkeletons() {
            let skeletons = '';
            for(let i = 0; i < 6; i++) {
                skeletons += `
                    <div class="card p-0 flex flex-col skeleton-card">
                        <div class="skeleton w-full h-32"></div>
                        <div class="p-4">
                            <div class="skeleton h-5 w-3/4 mb-2"></div>
                            <div class="skeleton h-4 w-1/2 mb-1"></div>
                            <div class="skeleton h-4 w-1/3"></div>
                        </div>
                        <div class="p-4 border-t border-panel-2 mt-auto">
                            <div class="flex justify-between items-center">
                                <div class="skeleton h-6 w-1/3"></div>
                                <div class="skeleton h-10 w-1/2"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return `<div class="search-results-grid">${skeletons}</div>`;
        },
        render_search_results() {
            const { query } = this.navigationContext;
            const filterCount = this.searchFilters.amenities.length + (this.searchFilters.type !== 'all' ? 1 : 0) + (this.searchFilters.priceRange ? 1 : 0) + (this.searchFilters.rating > 0 ? 1 : 0) + (this.searchFilters.stops !== null ? 1 : 0);
            
            let resultsHTML = '';
            if (this.searchView === 'List') {
                resultsHTML = this._renderSearchResultsHTML(query);
            } else {
                resultsHTML = `
                    <div class="card p-4 map-placeholder">
                        <div class="map-placeholder-content text-muted">
                            <i class="ph-map-trifold text-6xl"></i>
                            <p class="font-semibold mt-2">Map View is not available in this demo</p>
                            <p class="text-sm">In a real app, this would show interactive pins.</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-3">
                    <div>
                        <h2 class="text-lg font-semibold">Search Results</h2>
                        <p class="text-sm text-muted">Showing results for "${query}"</p>
                    </div>
                    <!-- View Toggle -->
                    <div class="flex items-center gap-2 mt-2 md:mt-0">
                        <div class="bg-bg p-1 rounded-full flex">
                            <button data-action="setSearchView" data-view="List" class="search-view-toggle ${this.searchView === 'List' ? 'active' : ''}">
                                <i class="ph-list text-lg mr-1.5"></i> List
                            </button>
                            <button data-action="setSearchView" data-view="Map" class="search-view-toggle ${this.searchView === 'Map' ? 'active' : ''}">
                                <i class="ph-map-pin text-lg mr-1.5"></i> Map
                            </button>
                        </div>
                        <button data-action="showSearchFilters" class="btn-secondary-outline !p-2.5 !w-10 !h-10 relative">
                            <i class="ph-funnel text-xl"></i>
                            ${filterCount > 0 ? `<span class="filter-count">${filterCount}</span>` : ''}
                        </button>
                    </div>
                </div>
                
                <!-- Compare Button -->
                <button id="compare-btn" data-action="showCompareModal" class="btn-primary w-full sticky top-2 z-20 mb-3 !py-2.5 hide">
                    <i class="ph-arrows-left-right text-lg mr-2"></i> <span>Compare (0)</span>
                </button>

                <div id="search-results-container" class="space-y-3">
                    ${resultsHTML}
                </div>
            `;
        },
        render_marketplace() {
            return `
                <div class="space-y-4">
                    <!-- Flash Sales -->
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-danger">Flash Sales 🔥</h2>
                        <div class="space-y-3">
                            ${mockData.deals.filter(d => d.type === 'Flash Sale').map(deal => {
                                const isSaved = this.savedItems.packages.has(deal.packageId);
                                return `
                                <div class="card p-0 overflow-hidden">
                                    <div class="relative">
                                        <div class="card-actions">
                                            <button data-action="toggleSaveItem" data-id="${deal.packageId}" data-type="Package" class="card-action-btn save ${isSaved ? 'active' : ''}" title="Save Item">
                                                <i class="ph-bookmark-simple text-lg"></i>
                                            </button>
                                        </div>
                                        <img src="${deal.img}" class="w-full h-32 object-cover" alt="${deal.title}" onerror="this.src='https://placehold.co/600x400/f1f5f9/475569?text=Image+Not+Found'">
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <h3 class="font-semibold">${deal.title}</h3>
                                            <span class="text-sm font-bold text-white py-1 px-3 rounded-full bg-danger">${deal.discount}</span>
                                        </div>
                                        <p class="text-xs text-muted mt-1">${deal.description}</p>
                                        <p class="text-sm font-bold text-center my-2 py-1 bg-danger-bg text-danger-text rounded countdown-timer" data-expiration="${deal.expiration}">Ends in: ...</p>
                                        <button data-action="buildItinerary" data-package-id="${deal.packageId}" class="btn-primary w-full !text-sm !py-2">Build Itinerary</button>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <!-- Exclusive Deals -->
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-brand">Exclusive Deals 🌟</h2>
                        <div class="search-results-grid">
                            ${mockData.deals.filter(d => d.type === 'Exclusive').map(deal => {
                                const isSaved = this.savedItems.packages.has(deal.packageId);
                                return `
                                <div class="card p-0 overflow-hidden relative">
                                    <div class="card-actions">
                                        <button data-action="toggleSaveItem" data-id="${deal.packageId}" data-type="Package" class="card-action-btn save ${isSaved ? 'active' : ''}" title="Save Item">
                                            <i class="ph-bookmark-simple text-lg"></i>
                                        </button>
                                    </div>
                                    <img src="${deal.img}" class="w-full h-24 object-cover" alt="${deal.title}" onerror="this.src='https://placehold.co/600x400/f1f5f9/475569?text=Image+Not+Found'">
                                    <div class="p-3">
                                        <h3 class="font-semibold text-sm">${deal.title}</h3>
                                        <p class="text-xs text-muted mt-1">${deal.description}</p>
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="text-sm font-bold py-1 px-2 rounded-full bg-brand-bg text-brand-text">${deal.discount}</span>
                                            <button data-action="buildItinerary" data-package-id="${deal.packageId}" class="btn-secondary-outline !text-xs !py-1 !px-3">Build</button>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;
        },
        render_more() {
            const moreLinks = [
                { view: 'team_hub', icon: 'ph-users-three', title: 'Team Hub' },
                { view: 'trust_hub', icon: 'ph-handshake', title: 'Trust Hub' },
                { view: 'clients', icon: 'ph-users', title: 'Clients' },
                { view: 'finance', icon: 'ph-currency-inr', title: 'Finance' },
                { view: 'analytics', icon: 'ph-chart-bar', title: 'Analytics' },
                { view: 'profile', icon: 'ph-user-circle', title: 'My Profile' },
            ];
            // This view is mobile-only, wrapped to hide on desktop
            return `
                <div class="space-y-4 lg:hidden">
                    <div class="card !p-0 divide-y divide-panel-2">
                        ${moreLinks.map(link => `
                            <div data-action="navigate" data-view="${link.view}" class="settings-link">
                                <i class="ph ${link.icon} text-xl"></i>
                                <span>${link.title}</span>
                                <i class="ph-caret-right text-lg"></i>
                            </div>
                        `).join('')}
                    </div>
                    <div class="card !p-0">
                        <div data-action="logout" class="settings-link text-danger">
                            <i class="ph-sign-out text-xl"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            `;
        },
        render_trust_hub() {
            const { user } = mockData;
            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h3 class="text-lg font-semibold mb-3">Your Community Rank</h3>
                        <div class="flex items-center justify-between">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-brand">#${user.rank}</p>
                                <p class="text-xs text-muted">Overall</p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-bold text-warn">${user.points}</p>
                                <p class="text-xs text-muted">Points</p>
                            </div>
                            <button data-action="showLeaderboard" class="btn-secondary-outline !text-sm !py-2 !px-4">Leaderboard</button>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                            ${user.badges.map(badge => `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-warn-bg text-warn-text">${badge}</span>`).join('')}
                        </div>
                    </div>
                    <div id="supplier-list" class="card p-4">
                        <h2 class="text-lg font-semibold mb-3">Supplier Directory</h2>
                        <div class="space-y-3">
                            ${mockData.suppliers.map(s => this._renderItemCard(s)).join('')}
                        </div>
                    </div>
                </div>
            `;
        },
        render_supplier_details() {
            const { supplierId } = this.navigationContext;
            const supplier = mockData.suppliers.find(s => s.id === supplierId);
            if (!supplier) return `<h1>Supplier not found.</h1>`;
            
            const wordCloudData = supplier.peerReviews
                .flatMap(r => r.comment.toLowerCase().replace(/[.,!?;:]/g, '').split(/\s+/))
                .filter(word => word.length > 3 && !['this', 'that', 'with', 'very', 'they', 'their', 'service', 'always', 'good'].includes(word))
                .reduce((acc, word) => {
                    acc[word] = (acc[word] || 0) + 1;
                    return acc;
                }, {});
            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h2 class="text-xl font-bold">${supplier.name} ${supplier.verified ? '<i class="ph-seal-check-fill text-info inline-block ml-1"></i>' : ''}</h2>
                        <p class="text-sm text-muted">${supplier.service}</p>
                        <div class="flex justify-between items-center mt-3">
                            <div><p class="font-bold text-3xl text-warn">${supplier.rating}<span class="text-lg opacity-70">/5</span></p><p class="text-xs text-muted">Avg. Rating</p></div>
                            <div><p class="font-bold text-3xl text-brand">${supplier.trustScore}<span class="text-lg opacity-70">/100</span></p><p class="text-xs text-muted">Trust Score</p></div>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Peer Review Insights</h3>
                        <canvas id="supplier-peer-review-chart" height="150" class="max-w-full"></canvas>
                        <div class="mt-4">
                            <p class="text-xs font-semibold text-muted mb-2">COMMON FEEDBACK</p>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(wordCloudData).sort((a,b) => b[1] - a[1]).slice(0,7).map(([word, count]) => `
                                    <span class="text-xs font-medium bg-panel-2 px-2 py-1 rounded-md">${word} (${count})</span>
                                `).join('')}
                                ${Object.keys(wordCloudData).length === 0 ? '<span class="text-xs text-muted">No significant feedback patterns found.</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Leave a Review</h3>
                        <textarea id="review-comment" placeholder="Share your experience..." class="w-full h-24 mb-2"></textarea>
                        <button data-action="submitReview" data-supplier-id="${supplier.id}" class="btn-primary w-full">Submit Review</button>
                    </div>
                </div>
            `;
        },
        render_walkthrough() {
            // This view is now rendered by the showContextualHelp modal
            // We just navigate to dashboard and show the help
            this.navigate('dashboard');
            this.showContextualHelp();
            return ``;
        },
        renderCharts() {
            const { revenue, revenueLabels, bookingsByDest, bookingsByDestLabels } = mockData.analyticsData;
            const revenueChartEl = document.getElementById('revenue-chart');
            const bookingsChartEl = document.getElementById('bookings-chart');
            // Chart default colors and font
            Chart.defaults.color = 'var(--muted)';
            Chart.defaults.font.family = 'system-ui, sans-serif';
            if (revenueChartEl) {
                try {
                    this.charts.revenue = new Chart(revenueChartEl, {
                        type: 'line',
                        data: {
                            labels: revenueLabels,
                            datasets: [{
                                label: 'Revenue (Lakhs)',
                                data: revenue,
                                borderColor: 'var(--brand)',
                                backgroundColor: 'var(--brand-bg)',
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: 'var(--brand)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'var(--brand)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                } catch (e) { console.error("Error rendering revenue chart:", e); }
            }
            if (bookingsChartEl) {
                try {
                    this.charts.bookings = new Chart(bookingsChartEl, {
                        type: 'doughnut',
                        data: {
                            labels: bookingsByDestLabels,
                            datasets: [{
                                label: 'Bookings',
                                data: bookingsByDest,
                                backgroundColor: ['var(--brand)', 'var(--ok)', 'var(--warn)', 'var(--danger)', 'var(--info)'],
                                borderColor: 'var(--panel)',
                                borderWidth: 4,
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, color: 'var(--text)' } }
                            }
                        }
                    });
                } catch (e) { console.error("Error rendering bookings chart:", e); }
            }
        },
        renderSupplierPeerReviewChart() {
            const { supplierId } = this.navigationContext;
            const supplier = mockData.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            const ratingCounts = supplier.peerReviews.reduce((acc, review) => {
                const ratingIndex = Math.max(0, Math.min(4, Math.round(review.rating) - 1)); // Ensure index is 0-4
                acc[ratingIndex] = (acc[ratingIndex] || 0) + 1;
                return acc;
            }, [0, 0, 0, 0, 0]); // Initialize counts for 1-5 stars
            const chartEl = document.getElementById('supplier-peer-review-chart');
            if (chartEl) {
                try {
                    this.charts.supplierPeerReviews = new Chart(chartEl, {
                        type: 'bar',
                        data: {
                            labels: ['1 ★', '2 ★', '3 ★', '4 ★', '5 ★'],
                            datasets: [{
                                label: 'Number of Peer Reviews',
                                data: ratingCounts,
                                backgroundColor: [
                                    'rgba(239, 68, 68, 0.6)',   // danger
                                    'rgba(249, 115, 22, 0.6)', // orange-500 approx
                                    'rgba(245, 158, 11, 0.6)', // warn
                                    'rgba(132, 204, 22, 0.6)', // lime-500 approx
                                    'rgba(16, 185, 129, 0.6)'  // ok
                                ],
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bars
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0,0,0,0.05)' },
                                    ticks: { stepSize: 1 } // Ensure integer ticks for counts
                                },
                                y: { grid: { display: false } }
                            }
                        }
                    });
                } catch (e) { console.error("Error rendering supplier chart:", e); }
            }
        },
        renderStaffPerformanceChart() {
            const { staffId } = this.navigationContext;
            const staff = mockData.staff.find(s => s.id === staffId);
            if (!staff) return;
            
            const chartEl = document.getElementById('staff-performance-chart');
            if (chartEl) {
                try {
                    const progress = Math.min(100, (staff.stats.revenue / staff.stats.monthlyGoal) * 100);
                    this.charts.staffPerformance = new Chart(chartEl, {
                        type: 'doughnut',
                        data: {
                            labels: ['Revenue', 'Remaining'],
                            datasets: [{
                                label: 'Monthly Goal',
                                data: [progress, 100 - progress],
                                backgroundColor: [
                                    'var(--ok)',
                                    'var(--panel-2)'
                                ],
                                borderColor: 'var(--card-bg)',
                                borderWidth: 4,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });
                } catch (e) { console.error("Error rendering staff chart:", e); }
            }
        },
        renderTeamHubCharts() {
            mockData.staff.forEach(staff => {
                const chartEl = document.getElementById(`staff-chart-${staff.id}`);
                if (chartEl) {
                    try {
                        const progress = Math.min(100, (staff.stats.revenue / staff.stats.monthlyGoal) * 100);
                        this.charts[staff.id] = new Chart(chartEl, {
                            type: 'doughnut',
                            data: {
                                datasets: [{
                                    data: [progress, 100 - progress],
                                    backgroundColor: ['var(--ok)', 'var(--bg)'],
                                    borderColor: 'var(--panel)',
                                    borderWidth: 4,
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '75%',
                                plugins: { legend: { display: false }, tooltip: { enabled: false } }
                            }
                        });
                    } catch (e) { console.error("Error rendering staff chart:", e); }
                }
            });
        },
        render_team_hub() {
            const { user } = mockData;
            if (user.role !== 'Admin' && user.role !== 'Manager') {
                return `<div class="card p-5 text-center"><p class="text-muted">You do not have permission to view this page.</p></div>`;
            }

            const getInitials = (name) => name ? name.split(' ').map(n => n[0]).join('') : '?';
            
            const performanceHTML = `
                <div class->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Staff Performance</h3>
                        <button data-action="addNewStaff" class="btn-primary !text-sm !py-2 !px-4">Add Staff</button>
                    </div>
                    <div class="space-y-3">
                        ${mockData.staff.map(staff => {
                            const progress = (staff.stats.revenue / staff.stats.monthlyGoal) * 100;
                            return `
                                <div data-action="navigate" data-view="staff_details" data-staff-id="${staff.id}" class="card p-3 cursor-pointer hover:shadow-md">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-brand-bg text-brand-text text-sm font-bold flex items-center justify-center mr-3">${getInitials(staff.name)}</div>
                                            <div>
                                                <p class="font-semibold text-sm">${staff.name}</p>
                                                <p class="text-xs text-muted">${staff.role} - ${staff.team}</p>
                                            </div>
                                        </div>
                                        <div class="relative h-12 w-12">
                                            <canvas id="staff-chart-${staff.id}"></canvas>
                                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                <span class="text-xs font-bold text-ok">${Math.round(progress)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right mt-1">
                                        <p class="text-sm font-bold">₹${staff.stats.revenue.toLocaleString('en-IN')} <span class="text-xs text-muted font-normal">/ ₹${staff.stats.monthlyGoal.toLocaleString('en-IN')}</span></p>
                                    </div>
                                </div>
                                `
                        }).join('')}
                    </div>
                </div>
            `;
            
            const activityHTML = `
                <div class="flex flex-col h-full">
                    <h3 class="text-lg font-semibold mb-3">Full Team Activity Log</h3>
                    <div class="space-y-3 flex-1 overflow-y-auto">
                    ${mockData.teamActivity.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(activity => {
                        const timeAgo = new Date(activity.timestamp).toLocaleString('en-IN', {day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit'});
                        return `
                            <div class="text-sm flex items-start border-b border-panel-2 pb-2 last:border-b-0">
                                <i class="ph-info text-info mr-3 mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <p>${activity.text}</p>
                                    <p class="text-xs text-muted mt-1">${timeAgo}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    </div>
                </div>
            `;
            
            // Mobile View with Toggle
            const mobileHTML = `
                <div class="space-y-4 lg:hidden">
                    <div class="app-tab-container">
                        <button data-action="changeTeamHubTab" data-tab="Performance" class="app-tab-item ${this.teamHubTab === 'Performance' ? 'active' : ''}">
                            Performance
                        </button>
                        <button data-action="changeTeamHubTab" data-tab="Activity" class="app-tab-item ${this.teamHubTab === 'Activity' ? 'active' : ''}">
                            Activity
                        </button>
                    </div>
                    <div class="card p-4">
                        ${this.teamHubTab === 'Performance' ? performanceHTML : activityHTML}
                    </div>
                </div>
            `;
            
            // Desktop View Side-by-Side
            const desktopHTML = `
                <div class="hidden lg:grid lg:grid-cols-2 lg:gap-4 space-y-4 lg:space-y-0">
                    <div class="card p-4">${performanceHTML}</div>
                    <div class="card p-4">${activityHTML}</div>
                </div>
            `;

            return mobileHTML + desktopHTML;
        },
        render_staff_details() {
            const { staffId } = this.navigationContext;
            const staff = mockData.staff.find(s => s.id === staffId);
            if (!staff) return `<h1>Staff member not found.</h1>`;

            const progress = (staff.stats.revenue / staff.stats.monthlyGoal) * 100;
            const getInitials = (name) => name ? name.split(' ').map(n => n[0]).join('') : '?';
            const staffBookings = mockData.bookings.filter(b => b.assignedTo === staff.name || b.assignedTo === staff.team);
            
            return `
                <div class="space-y-4">
                    <div class="card p-4 text-center">
                        <div class="w-20 h-20 rounded-full bg-brand-bg text-brand-text text-3xl font-bold flex items-center justify-center mx-auto">${getInitials(staff.name)}</div>
                        <h2 class="text-xl font-bold mt-3">${staff.name}</h2>
                        <p class="text-muted">${staff.role} - ${staff.team}</p>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Monthly Performance</h3>
                        <div class="relative h-40">
                            <canvas id="staff-performance-chart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-3xl font-bold text-ok">${Math.round(progress)}%</span>
                                <span class="text-xs text-muted">of Goal</span>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-lg font-bold">₹${staff.stats.revenue.toLocaleString('en-IN')}</p>
                            <p class="text-xs text-muted">Goal: ₹${staff.stats.monthlyGoal.toLocaleString('en-IN')}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="card p-3 text-center">
                            <p class="text-2xl font-bold">${staff.stats.closed}</p>
                            <p class="text-xs text-muted">Bookings Closed</p>
                        </div>
                        <div class="card p-3 text-center">
                            <p class="text-2xl font-bold">${staff.stats.margin}%</p>
                            <p class="text-xs text-muted">Avg. Margin</p>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Assigned Bookings (${staffBookings.length})</h3>
                        <div class="space-y-2">
                            ${staffBookings.length > 0 ? staffBookings.map(b => `
                                <div data-action="navigate" data-view="booking_details" data-booking-id="${b.id}" class="border-b border-panel-2 pb-2 last:border-b-0 flex justify-between items-center cursor-pointer hover:bg-panel-2 -mx-2 px-2 py-1 rounded">
                                    <div>
                                        <p class="font-semibold text-sm">${b.client}</p>
                                        <p class="text-xs text-muted">${b.destination}</p>
                                    </div>
                                    <span class="status ${b.status === 'Completed' ? 'ok' : (b.status === 'In-Progress' ? 'info' : 'warn')}">${b.status}</span>
                                </div>
                            `).join('') : '<p class="text-sm text-center py-4 text-muted">No bookings assigned.</p>'}
                        </div>
                    </div>
                </div>
            `;
        },
        render_clients() {
            const tabs = ['Active', 'All', 'New'];
            let filteredClients = [];
            if (this.clientsTab === 'Active') {
                filteredClients = mockData.clients.filter(c => c.totalBookings > 1);
            } else if (this.clientsTab === 'New') {
                filteredClients = mockData.clients.filter(c => c.totalBookings <= 1);
            } else {
                filteredClients = mockData.clients;
            }

            return `
                <div class="space-y-4">
                    <div class="app-tab-container">
                        ${tabs.map(tab => `
                            <button data-action="changeClientsTab" data-tab="${tab}" class="app-tab-item ${this.clientsTab === tab ? 'active' : ''}">
                                ${tab}
                            </button>
                        `).join('')}
                    </div>
                    <div class="card p-4">
                        <div class="space-y-3">
                            ${filteredClients.sort((a,b) => b.totalSpend - a.totalSpend).map(client => `
                                <div data-action="navigate" data-view="client_details" data-client-id="${client.id}" class="border-b border-panel-2 pb-3 last:border-b-0 flex justify-between items-center cursor-pointer hover:bg-panel-2 -mx-2 px-2 py-1 rounded">
                                    <div>
                                        <p class="font-semibold text-sm">${client.name}</p>
                                        <p class="text-xs text-muted">Last Trip: ${client.lastTrip}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-sm text-ok">₹${client.totalSpend.toLocaleString('en-IN')}</p>
                                        <p class="text-xs text-muted">${client.totalBookings} ${client.totalBookings > 1 ? 'bookings' : 'booking'}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },
        render_client_details() {
            const { clientId } = this.navigationContext;
            const client = mockData.clients.find(c => c.id === clientId);
            if (!client) return `<h1>Client not found.</h1>`;
            
            const clientBookings = mockData.bookings.filter(b => b.client === client.name);
            
            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h2 class="text-xl font-bold">${client.name}</h2>
                        <div class="grid grid-cols-2 gap-4 text-center mt-3">
                            <div>
                                <p class="text-2xl font-bold text-ok">₹${client.totalSpend.toLocaleString('en-IN')}</p>
                                <p class="text-xs text-muted">Total Spend</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold">${client.totalBookings}</p>
                                <p class="text-xs text-muted">Total Bookings</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button data-action="newItinerary" class="btn-primary flex items-center justify-center !text-sm !py-3"><i class="ph-scroll mr-2"></i>New Itinerary</button>
                            <button data-action="setReminder" data-client-name="${client.name}" class="btn-secondary-outline flex items-center justify-center !text-sm !py-3"><i class="ph-clock-counter-clockwise mr-2"></i>Set Reminder</button>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Communication Log</h3>
                        <div class="space-y-3">
                            ${client.communication.map(log => `
                                <div class="text-sm border-b border-panel-2 pb-2 last:border-b-0">
                                    <p>${log.log}</p>
                                    <p class="text-xs text-muted mt-1">${new Date(log.date).toLocaleDateString('en-IN', {day: 'numeric', month: 'short', year: 'numeric'})} - by ${log.by}</p>
                                </div>
                            `).join('')}
                            <textarea class="w-full h-20" placeholder="Log new activity..."></textarea>
                            <button class="btn-secondary-outline w-full !text-sm !py-2">Add Log</button>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Booking History</h3>
                        <div class="space-y-2">
                            ${clientBookings.length > 0 ? clientBookings.map(b => `
                                <div data-action="navigate" data-view="booking_details" data-booking-id="${b.id}" class="border-b border-panel-2 pb-2 last:border-b-0 flex justify-between items-center cursor-pointer hover:bg-panel-2 -mx-2 px-2 py-1 rounded">
                                    <div>
                                        <p class="font-semibold text-sm">${b.destination}</p>
                                        <p class="text-xs text-muted">Travelled: ${b.travelDate ? new Date(b.travelDate).toLocaleDateString('en-IN', {day: 'numeric', month: 'short'}) : 'N/A'}</p>
                                    </div>
                                    <span class="status ${b.status === 'Completed' ? 'ok' : (b.status === 'In-Progress' ? 'info' : 'warn')}">${b.status}</span>
                                </div>
                            `).join('') : '<p class="text-sm text-center py-4 text-muted">No booking history found.</p>'}
                        </div>
                    </div>
                </div>
            `;
        },
        render_finance() {
            const { user } = mockData;
            if (user.role !== 'Admin' && user.role !== 'Manager') {
                return `<div class="card p-5 text-center"><p class="text-muted">You do not have permission to view this page.</p></div>`;
            }

            const overdue = mockData.bookings.filter(b => b.invoice?.status === 'Overdue');
            const due = mockData.bookings.filter(b => b.invoice?.status === 'Due');
            const paid = mockData.bookings.filter(b => b.invoice?.status === 'Paid');

            const totalOverdue = overdue.reduce((sum, b) => sum + (b.invoice.amount - b.invoice.paid), 0);
            const totalDue = due.reduce((sum, b) => sum + (b.invoice.amount - b.invoice.paid), 0);
            const totalPaid = paid.reduce((sum, b) => sum + b.invoice.paid, 0);

            const getInvoiceRow = (b) => {
                let statusClass = '';
                switch(b.invoice.status) {
                    case 'Paid': statusClass = 'ok'; break;
                    case 'Due': statusClass = 'warn'; break;
                    case 'Overdue': statusClass = 'danger'; break;
                }
                return `
                    <tr class="border-b border-panel-2 last:border-b-0">
                        <td class="py-3 px-2 text-sm">
                            <p class="font-semibold">${b.invoice.id}</p>
                            <p class="text-xs text-muted">${b.client}</p>
                        </td>
                        <td class="py-3 px-2 text-sm text-right">₹${b.invoice.amount.toLocaleString('en-IN')}</td>
                        <td class="py-3 px-2 text-sm text-right">
                            <span class="status ${statusClass}">${b.invoice.status}</span>
                        </td>
                        <td class="py-3 px-2 text-sm text-center">
                            ${b.invoice.status !== 'Paid' ? `<button data-action="logPayment" data-booking-id="${b.id}" class="btn-secondary-outline !text-xs !py-1 !px-2">Log Payment</button>` : '-'}
                        </td>
                    </tr>
                `;
            };

            return `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="card p-4 text-center">
                            <p class="text-3xl font-bold text-danger">₹${totalOverdue.toLocaleString('en-IN')}</p>
                            <p class="text-xs text-muted">Overdue</p>
                        </div>
                        <div class="card p-4 text-center">
                            <p class="text-3xl font-bold text-warn">₹${totalDue.toLocaleString('en-IN')}</p>
                            <p class="text-xs text-muted">Due This Month</p>
                        </div>
                        <div class="card p-4 text-center">
                            <p class="text-3xl font-bold text-ok">₹${totalPaid.toLocaleString('en-IN')}</p>
                            <p class="text-xs text-muted">Paid This Month</p>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">All Invoices</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[400px]">
                                <thead>
                                    <tr class="border-b border-input-border text-left">
                                        <th class="py-2 px-2 text-xs font-semibold text-muted">Invoice / Client</th>
                                        <th class="py-2 px-2 text-xs font-semibold text-muted text-right">Amount</th>
                                        <th class="py-2 px-2 text-xs font-semibold text-muted text-right">Status</th>
                                        <th class="py-2 px-2 text-xs font-semibold text-muted text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[...overdue, ...due, ...paid].map(getInvoiceRow).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },
        render_analytics() {
            const { pricingAnalysis } = mockData.analyticsData;
            const pkg = mockData.searchResults.find(p => p.id === 'PKG_MANALI_01');
            const analysis = pricingAnalysis['PKG_MANALI_01'];
            const sliderValue = analysis.recommended;
            const commission = ((sliderValue - analysis.baseCost) / sliderValue * 100).toFixed(1);

            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Revenue Over Time (Last 6 Months)</h3>
                        <div class="h-64 lg:h-80">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Bookings by Destination</h3>
                        <div class="h-64 lg:h-80">
                            <canvas id="bookings-chart"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3 text-brand">✨ AI Pricing Optimizer</h3>
                        <p class="text-sm mb-3 text-muted">Analyze pricing for: <b>${pkg.title}</b></p>
                        <div class="text-center my-4">
                            <p class="text-xs text-muted">YOUR PRICE</p>
                            <p id="pricing-optimizer-price" class="text-4xl font-bold text-ok">₹${sliderValue.toLocaleString('en-IN')}</p>
                            <p id="pricing-optimizer-commission" class="text-sm font-semibold">${commission}% Commission</p>
                        </div>
                        <input id="pricing-optimizer-slider" type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand" min="${analysis.baseCost}" max="${analysis.marketAvg + 10000}" value="${sliderValue}">
                        <div class="flex justify-between text-xs text-muted mt-1">
                            <span>Base Cost: ₹${(analysis.baseCost/1000).toFixed(0)}k</span>
                            <span class="text-brand"><b>AI Rec: ₹${(analysis.recommended/1000).toFixed(0)}k</b></span>
                            <span>Market Avg: ₹${(analysis.marketAvg/1000).toFixed(0)}k</span>
                        </div>
                    </div>
                </div>
            `;
        },
        render_profile() {
            const { user } = mockData;
            const progress = (user.stats.revenue / user.stats.monthlyGoal) * 100;
            return `
                <div class="space-y-4">
                    <div class="card p-4 text-center">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=80&q=80" class="w-20 h-20 rounded-full mx-auto border-4 border-white shadow-md" alt="User Avatar" onerror="this.src='https://placehold.co/80x80/2563eb/FFFFFF?text=RK'">
                        <h2 class="text-xl font-bold mt-3">${user.name}</h2>
                        <p class="text-muted">${user.role} at ${user.agency}</p>
                        <div class="mt-3 flex flex-wrap gap-2 justify-center">
                            ${user.badges.map(badge => `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-warn-bg text-warn-text">${badge}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">My Monthly Performance</h3>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-muted">Revenue Goal</span>
                                <span class="font-semibold">₹${user.stats.revenue.toLocaleString('en-IN')} / ₹${user.stats.monthlyGoal.toLocaleString('en-IN')}</span>
                            </div>
                            <div class="w-full bg-panel-2 rounded-full h-2.5 overflow-hidden">
                                <div class="h-2.5 rounded-full bg-ok" style="width: ${progress}%;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-center mt-4">
                            <div class="bg-panel-2 p-3 rounded-lg">
                                <p class="text-2xl font-bold">${user.stats.closed}</p>
                                <p class="text-xs text-muted">Bookings Closed</p>
                            </div>
                            <div class="bg-panel-2 p-3 rounded-lg">
                                <p class="text-2xl font-bold">${user.stats.margin}%</p>
                                <p class="text-xs text-muted">Avg. Margin</p>
                            </div>
                        </div>
                    </div>

                    <div class="card !p-0 divide-y divide-panel-2">
                        <a href="#" class="settings-link">
                            <i class="ph-user-circle text-xl"></i>
                            <span>Edit Profile</span>
                            <i class="ph-caret-right text-lg"></i>
                        </a>
                        <a href="#" class="settings-link">
                            <i class="ph-key text-xl"></i>
                            <span>Change Password</span>
                            <i class="ph-caret-right text-lg"></i>
                        </a>
                        <a href="#" class="settings-link">
                            <i class="ph-bell text-xl"></i>
                            <span>Notifications</span>
                            <i class="ph-caret-right text-lg"></i>
                        </a>
                    </div>

                    <button data-action="logout" class="btn-danger-outline w-full">Logout</button>
                </div>
            `;
        },
        render_trip_dashboard() {
            const { bookingId, destination } = this.navigationContext;
            const booking = mockData.bookings.find(b => b.id === bookingId);
            const tripData = mockData.liveTripData[bookingId];
            if (!booking || !tripData) return `<h1>Trip data not found.</h1>`;
            
            const checklistHTML = tripData.checklist.length > 0
                ? tripData.checklist.map(category => `
                    <div class="mb-3">
                        <h4 class="font-semibold text-sm mb-2">${category.category}</h4>
                        <div class="space-y-1">
                            ${category.items.map(item => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="check-${item.text.replace(/\s+/g, '-')}" class="h-4 w-4 rounded border-gray-300 text-brand focus:ring-brand-bg" ${item.done ? 'checked' : ''}>
                                    <label for="check-${item.text.replace(/\s+/g, '-')}" class="ml-2 text-sm ${item.done ? 'line-through text-muted' : ''}">${item.text}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')
                : `<div class="text-center py-5">
                    <p class="text-sm text-muted mb-2">No checklist created.</p>
                    <button data-action="generateChecklist" data-booking-id="${bookingId}" class="btn-secondary-outline !text-sm !py-2 !px-4">✨ Generate AI Checklist</button>
                </div>`;

            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h2 class="text-lg font-bold">${booking.client}</h2>
                        <p class="text-sm text-muted">Trip to ${booking.destination}</p>
                        <div class="mt-2">
                            <span class="status info">${booking.status}</span>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Live Conditions</h3>
                        <div class="flex justify-between items-center bg-panel-2 p-3 rounded-lg">
                            <div>
                                <p class="text-sm text-muted">Weather in ${destination}</p>
                                <p class="text-2xl font-bold">${tripData.weather.temp}</p>
                            </div>
                            <p class="text-2xl">${tripData.weather.condition === 'Sunny' ? '☀️' : (tripData.weather.condition === 'Clear Skies' ? '🏙️' : '☁️')}</p>
                        </div>
                        ${tripData.news.length > 0 ? `
                            <div class="mt-3 bg-warn-bg text-warn-text p-3 rounded-lg text-sm font-medium flex items-start">
                                <i class="ph-warning-circle text-lg mr-2 mt-0.5"></i>
                                <span><b>Local News:</b> ${tripData.news[0]}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Pre-Departure Checklist</h3>
                        ${checklistHTML}
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3 text-brand">✨ Ask a Local Expert (AI)</h3>
                        <p class="text-sm mb-3 text-muted">Need a last minute tip? Ask about restaurants, timing, or local etiquette.</p>
                        <div id="local-expert-answer" class="mb-3"></div>
                        <div class="flex space-x-2">
                            <input type="text" id="local-expert-input" placeholder="e.g., Best place for dinner?">
                            <button id="ask-expert-btn" data-action="askLocalExpert" class="btn-primary !p-3 h-auto" style="border-radius: var(--radius-md);"><i class="ph-paper-plane-tilt text-2xl"></i></button>
                        </div>
                    </div>
                </div>
            `;
        },
        render_crisis() {
            const { crisis } = mockData;
            return `
                <div class="space-y-4">
                    <div class="card p-4 border-l-4 border-danger">
                        <h2 class="text-xl font-bold text-danger mb-2">CRISIS: ${crisis.issue}</h2>
                        <p class="font-semibold">${crisis.client} (${crisis.bookingId})</p>
                        <p class="text-sm text-muted">${crisis.impact}</p>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3 text-brand">✨ AI-Suggested Alternatives</h3>
                        <div class="space-y-3">
                            ${crisis.alternatives.map((alt, index) => `
                                <div class="border border-input-border rounded-lg p-3">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-xs font-semibold bg-panel-2 px-2 py-0.5 rounded-full">${alt.type}</span>
                                            <p class="font-semibold text-sm mt-1">${alt.details}</p>
                                        </div>
                                        <span class="text-sm font-semibold ${alt.cost.startsWith('+') ? 'text-danger' : 'text-ok'}">${alt.cost}</span>
                                    </div>
                                    <button class="w-full !text-sm !py-2 mt-3 ${index === 0 ? 'btn-primary' : 'btn-secondary-outline'}">
                                        ${index === 0 ? 'Confirm & Rebook' : 'Select Alternative'}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Bulk Communication</h3>
                        <button id="draft-crisis-update-btn" data-action="draftCrisisUpdate" class="btn-secondary-outline w-full !text-sm !py-2 mb-3">✨ Draft Crisis Update</button>
                        <textarea id="crisis-communication-textarea" class="w-full h-32" placeholder="Type message to client, suppliers, etc..."></textarea>
                        <button class="btn-danger w-full mt-2">Send Update to All</button>
                    </div>
                </div>
            `;
        },
        render_booking_details() {
            const { bookingId } = this.navigationContext;
            const booking = mockData.bookings.find(b => b.id === bookingId);
            if (!booking) return `<h1>Booking not found.</h1>`;

            let statusClass = '';
            switch(booking.status) {
                case 'Completed': statusClass = 'ok'; break;
                case 'Confirmed':
                case 'In-Progress': statusClass = 'info'; break;
                case 'Inquiry':
                case 'Quoted': statusClass = 'warn'; break;
            }
            
            let paymentHTML = '';
            if (booking.invoice) {
                const progress = booking.invoice.amount > 0 ? (booking.invoice.paid / booking.invoice.amount) * 100 : 0;
                let paymentStatusClass = '';
                switch(booking.invoice.status) {
                    case 'Paid': paymentStatusClass = 'ok'; break;
                    case 'Due': paymentStatusClass = 'warn'; break;
                    case 'Overdue': paymentStatusClass = 'danger'; break;
                }
                paymentHTML = `
                    <h3 class="text-lg font-bold mb-3">Payment Status</h3>
                    <div class="flex justify-between items-center mb-2">
                        <span class="status ${paymentStatusClass}">${booking.invoice.status}</span>
                        <span class="font-bold text-sm">₹${booking.invoice.paid.toLocaleString('en-IN')} / ₹${booking.invoice.amount.toLocaleString('en-IN')}</span>
                    </div>
                    <div class="w-full bg-panel-2 rounded-full h-2.5 overflow-hidden">
                        <div class="h-2.5 rounded-full ${progress < 100 ? 'bg-warn' : 'bg-ok'}" style="width: ${progress}%;"></div>
                    </div>
                    ${booking.invoice.status !== 'Paid' ? `
                        <button data-action="logPayment" data-booking-id="${booking.id}" class="btn-success w-full !text-sm !py-2 mt-3">Log Payment</button>
                    ` : ''}
                `;
            } else {
                paymentHTML = `
                    <h3 class="text-lg font-bold mb-2">Payment Status</h3>
                    <p class="text-sm text-muted mb-2">No invoice has been generated for this booking.</p>
                    ${booking.status === 'Confirmed' ? `
                        <button data-action="generateInvoice" data-booking-id="${booking.id}" class="btn-primary w-full !text-sm !py-2">Generate Invoice</button>
                    ` : ''}
                `;
            }

            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-xl font-bold">${booking.client}</h2>
                                <p class="text-sm text-muted">Trip to ${booking.destination}</p>
                            </div>
                            <span class="status ${statusClass}">${booking.status}</span>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-panel-2">
                            <div class="text-sm">
                                <p><b class="text-muted">Date:</b> ${booking.travelDate ? new Date(booking.travelDate).toLocaleDateString('en-IN', {day: 'numeric', month: 'long'}) : 'N/A'}</p>
                                <p><b class="text-muted">Travelers:</b> ${booking.travelers || 'N/A'}</p>
                                <p><b class="text-muted">Value:</b> <span class="font-bold text-ok">₹${booking.value.toLocaleString('en-IN')}</span></p>
                                <p><b class="text-muted">Assigned:</b> <button data-action="showAssignModal" data-booking-id="${booking.id}" class="btn-link !text-sm">${booking.assignedTo || 'Unassigned'}</button></p>
                            </div>
                            <button data-action="showEditBookingModal" data-booking-id="${booking.id}" class="btn-secondary-outline !p-2 !w-9 !h-9 !rounded-full"><i class="ph-pencil-simple text-lg"></i></button>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${booking.status === 'Inquiry' ? `<button data-action="buildQuoteFromInquiry" data-booking-id="${booking.id}" data-destination="${booking.destination}" class="btn-primary flex items-center justify-center !text-sm !py-3"><i class="ph-scroll mr-2"></i>Build Quote</button>` : ''}
                            ${booking.packageId ? `<button data-action="navigate" data-view="itinerary_builder" data-package-id="${booking.packageId}" data-booking-id="${booking.id}" class="btn-secondary-outline flex items-center justify-center !text-sm !py-3"><i class="ph-eye mr-2"></i>View Itinerary</button>` : ''}
                            <button data-action="navigate" data-view="client_details" data-client-id="${mockData.clients.find(c => c.name === booking.client)?.id || ''}" class="btn-secondary-outline flex items-center justify-center !text-sm !py-3"><i class="ph-user mr-2"></i>View Client</button>
                            ${booking.status === 'In-Progress' || (booking.status === 'Confirmed' && booking.travelDate) ? `<button data-action="navigate" data-view="trip_dashboard" data-booking-id="${booking.id}" data-destination="${booking.destination}" class="btn-primary !bg-info flex items-center justify-center !text-sm !py-3"><i class="ph-airplane-takeoff mr-2"></i>Live Dashboard</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="card p-4">
                        ${paymentHTML}
                    </div>
                </div>
            `;
        },
        render_itinerary_builder() {
            if (!this.currentItinerary) {
                this.navigate('search');
                return `<p>Loading itinerary...</p>`;
            }

            const { title, dayWisePlan, totalPrice, profit, margin, clientName, destination } = this.currentItinerary;
            const addonPool = mockData.aiRecommendations[destination] || mockData.aiRecommendations.Default;

            return `
                <div class="space-y-4">
                    <div class="card p-4">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <p class="text-sm text-muted">For: <b>${clientName}</b></p>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Day-wise Plan</h3>
                        <button id="optimize-itinerary-btn" data-action="optimizeItinerary" class="btn-secondary-outline w-full !text-sm !py-2 mb-3">✨ Optimize with AI</button>
                        <div class="space-y-3">
                            ${dayWisePlan.map((day, index) => {
                                const hotel = mockData.hotels.find(h => h.id === day.hotelId);
                                return `
                                    <div class="border border-input-border rounded-lg p-3">
                                        <h4 class="font-bold text-sm mb-2">Day ${day.day}: ${day.title}</h4>
                                        <ul class="list-disc pl-5 text-sm space-y-1 text-muted">
                                            ${day.activities.map(act => `<li>${act}</li>`).join('')}
                                        </ul>
                                        ${hotel ? `
                                        <div class="mt-3 pt-3 border-t border-panel-2 flex items-center justify-between">
                                            <div class="flex items-center">
                                                <img src="${hotel.img}" class="w-8 h-8 rounded-md object-cover mr-2" alt="${hotel.name}" onerror="this.src='https://placehold.co/40x40/f1f5f9/475569?text=?'">
                                                <div>
                                                    <p class="text-xs font-semibold">${hotel.name}</p>
                                                    <p class="text-xs text-muted">${hotel.rating} ★</p>
                                                </div>
                                            </div>
                                            <button data-action="showHotelOptions" data-day-index="${index}" class="btn-secondary-outline !text-xs !py-1 !px-3">Change</button>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3 text-brand">✨ AI-Suggested Add-ons</h3>
                        <div class="space-y-2">
                            ${addonPool.map(addon => {
                                const isAdded = this.currentItinerary.addons.find(a => a.id === addon.id);
                                return `
                                    <div class="border border-input-border rounded-lg p-3 flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold text-sm">${addon.title}</p>
                                            <p class="text-xs text-muted">+ ₹${addon.price.toLocaleString('en-IN')}</p>
                                        </div>
                                        <button data-action="addItineraryAddon" data-addon-id="${addon.id}" class="btn-secondary-outline !text-xs !py-1 !px-3 ${isAdded ? 'quick-add-active' : ''}" ${isAdded ? 'disabled' : ''}>
                                            ${isAdded ? 'Added' : 'Add'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="text-lg font-bold mb-3">Quote Summary</h3>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span class="text-muted">Base Package:</span> <span>₹${this.currentItinerary.price.toLocaleString('en-IN')}</span></div>
                            ${this.currentItinerary.addons.map(a => `
                                <div class="flex justify-between"><span class="text-muted">Add-on: ${a.title}</span> <span>+ ₹${a.price.toLocaleString('en-IN')}</span></div>
                            `).join('')}
                            <hr class="border-panel-2 my-2">
                            <div class="flex justify-between font-bold text-lg"><span>Total Price:</span> <span class="text-ok">₹${totalPrice.toLocaleString('en-IN')}</span></div>
                            <div class="flex justify-between text-xs text-muted"><span>Est. Profit:</span> <span>₹${profit.toLocaleString('en-IN')} (${margin}%)</span></div>
                        </div>
                        <button data-action="generateQuote" class="btn-primary w-full !text-lg !py-3 mt-4">Generate & Send Quote</button>
                    </div>
                </div>
            `;
        },

        // Fallback for any other view not fully implemented
        _renderComingSoon(pageName) {
            // Note: render_walkthrough is removed, it's now handled by showContextualHelp()
            return `<div class="card text-center p-10">
                <i class="ph-clock text-4xl text-muted mb-4"></i>
                <h2 class="text-xl font-semibold mb-2">${pageName}</h2>
                <p class="text-muted">This section is under construction.</p>
            </div>`;
        }
    };
    // Initialize the app after the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        app.init();
        // app.login(); // Uncomment to automatically login for testing
    });
    </script>
</body>
</html>
